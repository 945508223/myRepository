debugger;var appId=YCDCommon.Win.getUrlParam("appId");var appArr=initAppForPage();window.onload=function(){YCDCommon.loading("on_load")};function on_load(){registerChildren();registerParent()}function initAppForPage(){if(appId&&getProjectName()!="/console_portal"){return[{APPID:appId,PROJECTNAME:getProjectName().substring(1)}]}var e="/console_portal";var t=e+"/sysconfig/getTreeData";var r={table:"dm_base_apps_view",id:"GUID",name:"'['||ITEMCODE||']'||ITEMNAME",pid:"SUPERGUID",order:"t.ITEMCODE",wherestr:"",rootText:"系统",dbSource:"",otherCols:",APPURL,PROJECTNAME,APPID,ITEMCODE"};var a=YCDCommon.Ajax.syncAjax(t,r);if(a.isError){alert(a.errMsg)}return a.result}function registerParent(){window.vm=new Vue({el:"#content",data:{step:{active:0,max:4,buttonArr:[{text:"上一步",fun:"last"},{text:"下一步",fun:"next"},{text:"开始导入",fun:"beginImport"},{text:"关闭",fun:"close"}],showBtn:[{next:true,close:true},{last:true,next:true,close:true},{last:true,next:true,close:true},{last:true,beginImport:true,close:true}]},form:{table:"",fileList:[],tableArr:getTablesByAppId(),action:getProjectName()+`/sysconfig/frame/upload/${(new Base64).encode("temp")}/false`},contrast:{excel:[],fields:[],fieldsObj:{},excelField:"",tableField:"",contrastMap:{},config:[],baseTableData:[],tableExtData:[],type:"1"},contrastTable:{currRowIndex:-1,currColField:"",transOptions:[]},extTable:{currRowIndex:-1,currColField:""},tableCol:[],tableData:[],rows:{inserted:[],updated:[],deleted:[]}},created:function(){},computed:{},watch:{},methods:{clickBtn:clickBtn,isShow:isShow,last:last,next:next,beginImport:beginImport,close:close_,changeFormTable:changeFormTable,beforeAvatarUpload:beforeAvatarUpload,handleRemove:handleRemove,handlePreview:handlePreview,handleExceed:handleExceed,beforeRemove:beforeRemove,upLoadSuccess:upLoadSuccess,buildContrast:buildContrast,assContrast:assContrast,cellClick:cellClick,rowClick:rowClick,rowClassName:rowClassName,computedEdit:computedEdit,delRow:delRow,getTransOptions:getTransOptions,extCellClick:extCellClick,extRowClick:extRowClick,extRowClassName:extRowClassName,extComputedEdit:extComputedEdit,loseInputFcous:loseInputFcous}})}function getTransOptions(e){var t=e.row;this.contrastTable.transOptions=[];var r=this.contrast.fieldsObj[t.TARGETFIELD];if(r&&(r.FIELD_TYPE=="006"||r.FIELD_TYPE=="011")){var a=getFieldsByTable(r.FK_TABLENAME);if(!a){this.$message.error("查询对应码表字段信息失败!");return false}this.contrastTable.transOptions=a}}function delRow(e){confirmFun(this,"是否确认删除?",function(t){var r=t.contrast.config;var a=e.row.UUID;for(var n=0;n<r.length;n++){if(a==r[n].UUID){r.splice(n,1)}delete t.contrast.contrastMap[e.row.TARGETFIELD]}},"已取消删除!")}function computedEdit(e){return e.column.columnKey===this.contrastTable.currColField&&e.$index===this.contrastTable.currRowIndex}function rowClassName({row:e,rowIndex:t}){e.index=t}function rowClick(e,t,r){this.contrastTable.currRowIndex=e.index}function cellClick(e,t,r,a){this.contrastTable.currColField=t.columnKey;this.$nextTick(function(){$(r).find("input").focus();if($(r).find(".el-select").length!=0){$(r).find("input").click()}$(r).find("input").keydown(function(e){var t=e.which;if(t==13){$(r).find("input").blur()}})})}function extRowClassName({row:e,rowIndex:t}){e.index=t}function extRowClick(e,t,r){this.extTable.currRowIndex=e.index}function extCellClick(e,t,r,a){this.extTable.currColField=t.columnKey;this.$nextTick(function(){$(r).find("input").focus();if($(r).find(".el-select").length!=0){$(r).find("input").click()}$(r).find("input").keydown(function(e){var t=e.which;if(t==13){$(r).find("input").blur()}})})}function extComputedEdit(e){return e.column.columnKey===this.extTable.currColField&&e.$index===this.extTable.currRowIndex}function loseInputFcous(e){debugger;this.extTable={currRowIndex:-1,currColField:""}}function assContrast(){if(!this.contrast.excelField){this.$message.error("请选择Excel表字段!");return false}if(!this.contrast.tableField){this.$message.error("请选择目标字段!");return false}if(this.contrast.contrastMap[this.contrast.tableField]){this.$message.error(`【${this.contrast.tableField}】目标字段已经建立字段映射,不允许重复!`);return false}this.contrast.contrastMap[this.contrast.tableField]=true;var e={UUID:generateUUID(),EXCELFIELD:this.contrast.excelField,TARGETFIELD:this.contrast.tableField,KEYFIELD:"0",TRANSCODING:"0",TRANSTFIELD:"",SAVETRANSTFIELD:""};this.contrast.config.push(deepClone(e))}function buildContrast(e){this.contrast[e.type]=e.value}function registerChildren(){Vue.component("model-ul",{props:["title","data","type","showname"],data:function(){return{curr:""}},computed:{},methods:{clickLi:function(e,t){this.curr=t;this.$emit("build-contrast",{type:e,value:t})},computedStyle:function(e){return{color:e===this.curr?"#409eff":"#909399",backgroundColor:e===this.curr?"#E6EEF8":"#FFFFFF"}},getTitle:function(e,t){var r=e.FIELD_NAMECN;return t?`${r}【${e.FIELD_NAME}】`:r}},template:$("#model-ul").html()});Vue.component("model-grid",{props:["tablename","tabledata","tablecol"],created:function(){},data:function(){return{currentPage:1,pageSize:10,pagedata:[]}},computed:{computed_data:function(){this.currentChangePage(this.currentPage);return this.pagedata},computed_total:function(){return this.tabledata.length}},methods:{handleCurrentChange:handleCurrentChange,handleSizeChange:handleSizeChange,currentChangePage:currentChangePage,getAlign:getAlign,compute_match_style:compute_match_style,delRowData:delRowData},template:$("#model-grid").html()})}function delRowData(e){debugger;var t=e.row;var r=this.tabledata;var a=false;for(var n=0;n<r.length;n++){if(a)continue;if(r[n]._rowKey==t._rowKey){r.splice(n,1);var o=false;if(t._ADDTTYPE=="更新"){for(var s=0;s<vm.$data.rows.updated.length;s++){if(o)continue;if(vm.$data.rows.updated[s]._rowKey==t._rowKey){vm.$data.rows.updated.splice(s,1);o=true}}}else{for(var s=0;s<vm.$data.rows.inserted.length;s++){if(o)continue;if(vm.$data.rows.inserted[s]._rowKey==t._rowKey){vm.$data.rows.inserted.splice(s,1);o=true}}}a=true}}}function compute_match_style(e){debugger;if(e.row._matching&&e.row._matching==e.column.property){return{background:"red",width:"100%",height:"100%"}}else{return{}}}function getAlign(e){return e.FIELD_TYPE=="001"||e.FIELD_TYPE=="002"?"right":"left"}function handleSizeChange(e){this.pageSize=e;this.handleCurrentChange(this.currentPage)}function handleCurrentChange(e){this.currentPage=e;this.currentChangePage(e)}function currentChangePage(e){let t=this.tabledata;let r=(e-1)*this.pageSize;let a=e*this.pageSize;var n=[];for(;r<a;r++){if(t[r]){n.push(t[r])}}this.pagedata=n}function isShow(e){return this.step.showBtn[this.step.active][e]}function clickBtn(e){this[e]()}function last(){if(this.step.active>0)this.step.active--}function next(){switch(this.step.active){case 0:if(!this.form.table){this.$message.error("请选择目标表!");return false}if(!this.form.fileList||this.form.fileList.length===0){this.$message.error("请上传Excel文件!");return false}if(!changeTableFildes(this)){this.$message.error("查询字段信息异常!");return false};break;case 1:var e={};for(var t=0;t<this.contrast.tableExtData.length;t++){e[this.contrast.tableExtData[t].TARGETFIELD]=this.contrast.tableExtData[t]}this.contrast.tableExtData=[];var r=this.contrast.fields;for(var a=0;a<r.length;a++){if(!this.contrast.contrastMap[r[a].FIELD_NAME]){if(e[r[a].FIELD_NAME]){this.contrast.tableExtData.push(e[r[a].FIELD_NAME])}else{this.contrast.tableExtData.push({TARGETFIELD:r[a].FIELD_NAME,TARGETFIELDCN:r[a].FIELD_NAMECN,KEYFIELD:"0",TARGETFIELDVAL:""})}}}break;case 2:if(!this.contrast.config||this.contrast.config.length==0){this.$message.error("请设置Excel字段和目标字段的关联关系!");return false}buildColData(this);if(!buildNewData(this))return false;break}if(this.step.active<this.step.max)this.step.active++}function buildColData(e){e.tableCol=[];var t=e.contrast.config;var r=e.contrast.tableExtData;var a=e.contrast.fieldsObj;for(var n=0;n<t.length;n++){var o=t[n].TARGETFIELD;var s=a[o];e.tableCol.push(s)}for(var i=0;i<r.length;i++){if(r[i].TARGETFIELDVAL){var o=r[i].TARGETFIELD;var s=a[o];e.tableCol.push(s)}}}function buildNewData(e){e.rows.inserted=[];e.rows.updated=[];e.rows.deleted=[];debugger;e.tableData=[];var t=e.contrast.config;var r={};var a={};if(e.contrast.type=="3"){var n=[];for(var o=0;o<t.length;o++){if(t[o].KEYFIELD=="1")n.push(t[o].TARGETFIELD)}if(!n||n.length==0){e.$message.error(`更新或追加导入方式未指定主键字段!`);return false}var s=selectAllTableData(e.form.table,n,"GUID");if(s&&s.rows)s=s.rows;for(var i=0;i<s.length;i++){var l=[];for(var c=0;c<n.length;c++){l.push(s[i][n[c]])}a[l.join("|")]=true}}var f={};var u=e.contrast.tableExtData;for(var d=0;d<u.length;d++){if(u[d].TARGETFIELDVAL){f[u[d].TARGETFIELD]=u[d].TARGETFIELDVAL}}var h=e.contrast.baseTableData;for(var g=0;g<h.length;g++){var p={};var m="";var E=[];for(var v=0;v<t.length;v++){E=[];var b=h[g][t[v].EXCELFIELD];if(t[v].TRANSCODING=="1"){var x=t[v].TARGETFIELD;var C=e.contrast.fieldsObj[x];var A=C.FK_TABLENAME;if(!r[A]){r[A]={};var D=C.FK_FIELDNAME;var T=t[v].TRANSTFIELD;if(!T){e.$message.error(`【${t[v].EXCELFIELD}】Excel字段设置转码未设置对应码表字段名!`);return false}var I=t[v].SAVETRANSTFIELD;if(!I)I="GUID";var F=selectAllTableData(A,[D,T,I],D);if(F&&F.rows)F=F.rows;for(var w=0;w<F.length;w++){r[A][F[w][T]]=F[w][I]}}b=r[A][b]?r[A][b]:"";if(!b){p["_matching"]=x}}p[t[v].TARGETFIELD]=b;if(t[v].KEYFIELD=="1"){E.push(b)}}Object.assign(p,deepClone(f));m=E.join("|");p._rowKey=generateUUID();if(e.contrast.type=="3"){if(a[m]){p["_ADDTTYPE"]="更新";e.rows.updated.push(p)}else{p["_ADDTTYPE"]="追加";e.rows.inserted.push(p)}}else{p["_ADDTTYPE"]="追加";e.rows.inserted.push(p)}e.tableData.push(p)}return true}function selectAllTableData(e,t,r,a,n,o,s){if(n){n=n.split(",");for(var i=0;i<n.length;i++){n[i]="t."+n[i]}n=n.join(",")}var l={tableName:e,columns:t?t.join(","):"",keyField:r,filter:a?JSON.stringify(a):"",order:n?n:"",customcolumns:o?o:"",dbSource:s?s:""};var c=getProjectNameByAppId(appId);var f=c+"/sysconfig/frame/getTableData";var u=YCDCommon.Ajax.syncAjax(f,l);if(!u){console.error("系统错误!");return null}return u}function beginImport(){debugger;if(this.contrast.type=="1"){var e=Object.keys(this.contrast.contrastMap);var t=selectAllTableData(this.form.table,e,"GUID");if(t&&t.rows)this.rows.deleted=t.rows}var r=getProjectNameByAppId(appId)+"/sysconfig/frame/saveData";var a={tableName:this.form.table,rows:JSON.stringify(this.rows),keyField:"GUID"};var n=YCDCommon.Ajax.syncAjax(r,a);if(n.isError){this.$message.error(`导入数据失败:${n.errMsg}`);return false}else{parent.alert("导入成功!");close_()}}function changeFormTable(e){this.form.table=e;this.contrast={excel:this.contrast.excel,fields:[],fieldsObj:{},excelField:"",tableField:"",contrastMap:{},config:[],baseTableData:this.contrast.baseTableData,tableExtData:[],type:"1"};this.contrastTable={currRowIndex:-1,currColField:"",transOptions:[]},this.extTable={currRowIndex:-1,currColField:""}}function beforeAvatarUpload(e){console.log(e);var t=e.name.substring(e.name.lastIndexOf(".")+1);if(!(t==="xls"||t==="xlsx")){this.$message.error("请上传Excel类型文件!(xls,xlsx)");return false}if(e.size/1024/1024/1024>1){this.$message.error("上传EXCEL大小不能超过 1GB!当前大小为:"+e.size/1024/1024/1024>1+"G");return false}return true}function handleRemove(e,t){console.log(e,t);this.form.fileList=t;this.contrast={excel:[],fields:[],fieldsObj:{},excelField:"",tableField:"",contrastMap:{},config:[],baseTableData:[],tableExtData:[],type:"1"}}function handlePreview(e){console.log(e)}function handleExceed(e,t){this.$message.warning(`当前限制选择 1 个文件，本次选择了 ${e.length} 个文件，共选择了 ${e.length+t.length} 个文件`)}function beforeRemove(e,t){if(e&&e.status==="success"){return this.$confirm(`确定移除 ${e.name}？`)}}function upLoadSuccess(e,t,r){debugger;if(e.isError){this.$message.error("上传失败!");return false}else{if(!e.result){this.$message.error("上传失败!");return false}var a={fileName:e.result.fileName,fileSize:e.result.fileSize,inFileName:e.result.inFileName,savepath:e.result.savepath};var n=YCDCommon.Ajax.syncAjax(getProjectName()+"/sysconfig/frame/parseExcel",{fileUrl:a.savepath+a.inFileName});if(n.isError){this.$message.error("解析Excel文件失败!");return false}else{this.form.fileList=r;this.contrast.baseTableData=n.result;if(this.contrast.baseTableData.length>0){this.contrast.excel=[];var o=this.contrast.baseTableData[0];for(var s in o){this.contrast.excel.push({FIELD_NAME:s,FIELD_NAMECN:s})}}}}}function getTablesByAppId(){var e=getProjectNameByAppId(appId);var t={appId:appId,tableName:""};var r=YCDCommon.Ajax.syncAjax(e+"/sysconfig/getAllTableNameList",t);if(r.isError){alert(r.errMsg);return}else{return r.result}}function changeTableFildes(e){var t=getFieldsByTable(e.form.table);if(!t)return false;e.contrast.fields=t;for(var r=0;r<t.length;r++){e.contrast.fieldsObj[t[r].FIELD_NAME]=t[r]}return true}function getFieldsByTable(e){var t=getProjectNameByAppId(appId);var r=t+"/sysconfig/frame/selectFactors";var a={tableName:e,appId:appId};var n=YCDCommon.Ajax.syncAjax(r,a);if(n.isError){console.error(n.errMsg);return false}else{return n.result}}function getProjectNameByAppId(e){if(!e)return"/console_portal";for(var t=0;t<appArr.length;t++){if(appArr[t].APPID==e)return"/"+appArr[t].PROJECTNAME}}function deepClone(e){function t(e){if(e===null)return"Null";if(e===undefined)return"Undefined";return Object.prototype.toString.call(e).slice(8,-1)}var r,a=t(e);if(a==="Object"){r={}}else if(a==="Array"){r=[]}else{return e}for(key in e){var n=e[key];if(t(n)=="Object"){r[key]=arguments.callee(n)}else if(t(n)=="Array"){r[key]=arguments.callee(n)}else{r[key]=e[key]}}return r}function generateUUID(){var e=(new Date).getTime();if(window.performance&&typeof window.performance.now==="function"){e+=performance.now()}var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+Math.random()*16)%16|0;e=Math.floor(e/16);return(t=="x"?r:r&3|8).toString(16)});return t}function confirmFun(e,t,r,a,n,o){e.$confirm(t,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{if(r){r(e,n)}}).catch(()=>{if(o)o(e,n);e.$message({type:"info",message:a})})}function selectRefFiled(e,t,r,a,n,o,s,i,l){var c=getProjectNameByAppId(appId);var f=e.FK_FILTER;if(f){var u=/\@\{.*?\}/g;var d=f.match(u);if(d!=null&&d.length>0){for(var h=0;h<d.length;h++){var g=d[h];var p=g.substring(2,g.length-1).toUpperCase();var m=null;if(o){m=o[p]}if(m){var E="'"+m+"'"}else{E=null}if(!E||E==null){console.error("数据过滤条件【"+g+"】未匹配到相应参数值，请检查！");return false}f=f.replaceAll("\\@{"+p+"}",E,false);e.FK_FILTER=f}}}if(s){s=s+(e.FK_FILTER?" and "+e.FK_FILTER:"")}else{s=e.FK_FILTER?e.FK_FILTER:""}if(i){s=s+" and "+i}var v;if(e.FK_TABLENAME=="DM_BASE_CODES"){v=YCDCommon.Ajax.syncAjax(c+"/sysconfig/frame/listBaseCode",{baseType:e.FK_FIELDNAME,superGuid:"*",dbSource:l!=null?l:"",filter:s})}else if(e.FK_TABLENAME=="CSSCODES"){if(e.FIELD_TYPE=="006"){v=YCDCommon.Ajax.syncAjax(c+"/sysconfig/getCssData",{fieldName:e.FK_FIELDNAME,filter:s,dbSource:l!=null?l:""})}else{v.result=[]}}else{var b={tableName:e.FK_TABLENAME,fieldName:e.FK_FIELDNAME,txtName:e.FK_TXTNAME,filter:s,dbSource:l!=null?l:""};v=YCDCommon.Ajax.syncAjax(c+"/sysconfig/getKffieldData",b)}if(v.isError){console.error("【"+e.FIELD_NAMECN+"】字段查询关联外键表【"+e.FK_TABLENAME+"】信息异常:"+v.errMsg);return false}v=v.result;v.reverse();if(a&&e.TYPE=="select"){var x=e.FIELD_NAMECN;if(e.FIELD_NAME=="SUPERGUID"){v.push({ID:"#",NAME:"---  请选择"+x+"  ---"})}else{v.push({ID:"",NAME:"---  请选择"+x+"  ---"})}}v.reverse();if(n){v=transData(v,"ID","PID","CHILDREN")}else{for(var C=0;C<v.length;C++){v[C][t]=v[C].NAME;v[C][r]=v[C].ID}}return v}function transData(e,t,r,a){var n=e;var o=[],s={},i=t,l=r,c=a,f=0,u=0,d=n.length;for(;f<d;f++){s[n[f][i]]=n[f]}for(;u<d;u++){var h=n[u],g=s[h[l]];if(g){!g[c]&&(g[c]=[]);g[c].push(h)}else{o.push(h)}}return o}function Base64(){_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.encode=function(e){var t="";var r,a,n,o,s,i,l;var c=0;e=_utf8_encode(e);while(c<e.length){r=e.charCodeAt(c++);a=e.charCodeAt(c++);n=e.charCodeAt(c++);o=r>>2;s=(r&3)<<4|a>>4;i=(a&15)<<2|n>>6;l=n&63;if(isNaN(a)){i=l=64}else if(isNaN(n)){l=64}t=t+_keyStr.charAt(o)+_keyStr.charAt(s)+_keyStr.charAt(i)+_keyStr.charAt(l)}return t};this.decode=function(e){var t="";var r,a,n;var o,s,i,l;var c=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(c<e.length){o=_keyStr.indexOf(e.charAt(c++));s=_keyStr.indexOf(e.charAt(c++));i=_keyStr.indexOf(e.charAt(c++));l=_keyStr.indexOf(e.charAt(c++));r=o<<2|s>>4;a=(s&15)<<4|i>>2;n=(i&3)<<6|l;t=t+String.fromCharCode(r);if(i!=64){t=t+String.fromCharCode(a)}if(l!=64){t=t+String.fromCharCode(n)}}t=_utf8_decode(t);return t};_utf8_encode=function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var r=0;r<e.length;r++){var a=e.charCodeAt(r);if(a<128){t+=String.fromCharCode(a)}else if(a>127&&a<2048){t+=String.fromCharCode(a>>6|192);t+=String.fromCharCode(a&63|128)}else{t+=String.fromCharCode(a>>12|224);t+=String.fromCharCode(a>>6&63|128);t+=String.fromCharCode(a&63|128)}}return t};_utf8_decode=function(e){var t="";var r=0;var a=c1=c2=0;while(r<e.length){a=e.charCodeAt(r);if(a<128){t+=String.fromCharCode(a);r++}else if(a>191&&a<224){c2=e.charCodeAt(r+1);t+=String.fromCharCode((a&31)<<6|c2&63);r+=2}else{c2=e.charCodeAt(r+1);c3=e.charCodeAt(r+2);t+=String.fromCharCode((a&15)<<12|(c2&63)<<6|c3&63);r+=3}}return t}}