var ptype="add";var data;var type=YCDCommon.Win.getUrlParam("type");if(!type)type="private";var guid=YCDCommon.Win.getUrlParam("GUID");var appId=YCDCommon.Win.getUrlParam("appId");var appPath=YCDCommon.Win.getUrlParam("appPath");if(!appPath)appPath=getProjectNameByAppId(appId);var id=YCDCommon.Win.getUrlParam("ds_id");var ds_name=YCDCommon.Win.getUrlParam("ds_name");var ispro=YCDCommon.Win.getUrlParam("ispro");var FUNSID=YCDCommon.Win.getUrlParam("FUNSID");var funObj=window.top[FUNSID];var js_Text="";if(id=="PAGE"&&ds_name=="ds_page_allloadsuccess"&&ispro){js_Text=parent.$DS.getPageProValByName("ds_page_allloadsuccess")}else if(FUNSID){funObj.win=window;js_Text=funObj.textFun(funObj)}else{js_Text=id?parent.VUECFG.formObj[id].info[ds_name]:null}var readOnly=YCDCommon.Win.getUrlParam("readOnly");var themeCode="idea";if(id&&id!="PAGE"){var info=parent.$DS.getCtrlById(id).info;themeCode=info.ds_theme?info.ds_theme:"idea"}let cm_opt={mode:"text/html",gutter:false,lineNumbers:true,autoCloseBrackets:true,styleActiveLine:true,theme:themeCode,lineWrapping:true,foldGutter:true,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],extraKeys:{"Alt-/":"autocomplete"},matchBrackets:true,matchTags:{bothTags:true},autoCloseTags:true};Object.assign(cm_opt,{mode:"text/javascript"});let js_editor=CodeMirror.fromTextArea(document.getElementById("code-js"),cm_opt);window.onload=function(){setTitle();if(readOnly){setReadOnly()}};function setReadOnly(){js_editor.setOption("readOnly",true);$("#sure").css("display","none")}function setTitle(){let e="";if(guid){if(type=="private"){e="页面脚本-"+YCDCommon.Win.getUrlParam("pageName")}else if(type=="pubjs"){e="-公共脚本-"+YCDCommon.Win.getUrlParam("ITEMNAME")}else if(type=="SQL"){e="预定义SQL-"+YCDCommon.Win.getUrlParam("ITEMNAME")}}document.getElementsByTagName("title")[0].innerText=e}if(guid){getJsValueByGuid()}else{if(js_Text)js_editor.setValue(js_Text)}$("#sure").bind("click",function(){save_js()});$("#cancle").bind("click",function(){if(guid){window.close()}else{close_()}});function getJsValueByGuid(){var e={};if(type=="SQL"){e={columns:"GUID,SQLBODY",tableName:"DM_FORM_SQLS",filter:`AND GUID='${guid}'`}}else if(type=="pubjs"||type=="private"){e={columns:"GUID,JS_TEXT",tableName:"DM_FORM_PAGEJS",filter:type=="private"?`AND ITEMCODE='${guid}'`:`AND GUID='${guid}'`}}var t=YCDCommon.Ajax.syncAjax(appPath+"/sysconfig/frame/selectFormInfo",e);if(t.isError){alert(t.errMsg);return false}else{data=t.result}if(data){ptype="edit";var a=new Base64;let e=type=="pubjs"||type=="private"?"JS_TEXT":"SQLBODY";var r="";if(!data[e]){r=""}else{if(type=="pubjs"||type=="private"){r=a.decode(data[e])}else if(type=="SQL"){r=data[e]}}if(r&&r!=""){js_editor.setValue(r)}}}function save_js(){var e=new Base64;var t=js_editor.getValue();if(guid&&(type==="private"||type==="pubjs"||type=="SQL")){var a=type==="private"?YCDCommon.Win.getUrlParam("pageName"):YCDCommon.Win.getUrlParam("ITEMNAME");var r=type==="private"?guid:YCDCommon.Win.getUrlParam("ITEMCODE");if(a.length>25){a=a.substring(0,25)}var i={ITEMNAME:a,ITEMCODE:r};if(type==="private"||type==="pubjs"){i["JS_TEXT"]=e.encode(t);i["TYPE"]=type}else{i["SQLBODY"]=t}if(ptype=="edit"){i["GUID"]=type==="private"?data.GUID:guid}var s={type:ptype,keyField:"GUID",tableName:type=="private"||type=="pubjs"?"DM_FORM_PAGEJS":"DM_FORM_SQLS",isRefOrderNum:"1",datas:JSON.stringify(i)};var n=YCDCommon.Ajax.syncAjax(appPath+"/sysconfig/frame/saveForm",s);if(!n){alert("保存失败!")}else if(n&&n.isError){alert(n.errMsg);return false}else{data=n.result.rowObj;ptype="edit";alert("保存成功!")}}else if(FUNSID){funObj.saveFun(t,funObj)}else{if(id=="ds_page_allloadsuccess"&&ispro){parent.$DS.setPro("PAGE","ds_page_allloadsuccess",ispro=="true"?"jseditor":"input",t)}else{parent.$DS.setPro(id,ds_name,ispro=="true"?"jseditor":"input",t)}close_();if(parent.VUECFG&&parent.VUECFG.viewStatu===false)parent.alert("请保存设计界面!</br>否则设置的JS文本将不会加载!")}}function selectTheme(e){js_editor.setOption("theme",e.target.value)}function getProjectNameByAppId(e){if(!e)return"/console_portal";var t=pageCfg.LEFT_FLITERBTN.data;for(var a=0;a<t.length;a++){if(t[a].APPID==e)return"/"+t[a].PROJECTNAME}}