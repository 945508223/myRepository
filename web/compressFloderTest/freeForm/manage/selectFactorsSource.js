var key=YCDCommon.Win.getUrlParam("key");var source=window.top[key];var tableIns1;var tableIns2;var fieldInfoArr={};var oldTableColumns=JSON.stringify(source.columns);var layTableId="layTable";$(document).ready(function(){var e=new Array;e.push({name:"确定",onclick:"save",classname:"ycd-icon-ok"});e.push({name:"关闭",onclick:"pageClose",classname:"ycd-icon-cancel"});YCDComponents.toolbar.formToolbar("main1",e);layui.use(["jquery","table","layer"],function(){var e=layui.$,a=layui.table;form=layui.form;layer=layui.layer;var t=getTableFieldData();for(var l=0;l<t.length;l++){fieldInfoArr[t[l].FIELD_NAME]=t[l]}var r="字段中文名";var i=e("#right_Table").width();tableIns1=a.render({elem:"#rightTable",id:"rightTable",height:"full-41",data:t,page:false,limit:1e21,title:"当前表字段:",toolbar:true,defaultToolbar:["filter",{title:"提示",layEvent:"LAYTABLE_TIPS",icon:"layui-icon-tips"}],cols:[[{type:"checkbox",width:.2*i-12},{field:"FIELD_NAME",title:"字段名",width:.4*i},{field:"FIELD_NAMECN",title:"字段中文名",width:.4*i},{field:"SHOW_NO",hide:true,sort:true},{field:"FIELD_TYPE",title:"字段类型",hide:true},{field:"SUPERFIELD_NAME",title:"上级字段",hide:true}]],done:function(a,t,l){addDimClass();e("#rightTable").next().find(".layui-table-body").find("table").find("tbody").children("tr").on("dblclick",function(){var t=JSON.stringify(e("#rightTable").next().find(".layui-table-body").find("table").find("tbody").find(".layui-table-hover").data("index"));var l=a.data[t];addClickData(l)})}});var n=e("#left_Table").width();var o=[];var d="layTable";tableIns2=a.render({elem:"#leftTable",id:d,height:"full-41",title:"已选择字段:",toolbar:"#jsonToolbar",defaultToolbar:["filter",{title:"提示",layEvent:"LAYTABLE_TIPS",icon:"layui-icon-tips"}],data:o,page:false,limit:1e21,cols:[[{type:"checkbox",width:.1*n-12},{field:"FIELD_NAME",title:"字段名",width:.375*n,align:"center",edit:"text"},{field:"FIELD_NAMECN",title:r,width:.375*n,edit:"text"},{field:"SHOW_WIDTH",title:"显示宽度",width:.15*n,align:"center",edit:"text"},{field:"FIELD_TYPE",title:"字段类型",hide:true},{field:"SUPERFIELD_NAME",title:"上级字段",hide:true}]],done:function(e,a,t){addBusClass()}});a.on("toolbar(leftTable)",function(e){var t=a.checkStatus(e.config.id);switch(e.event){case"insertData":var l=a.cache[d];var r={FIELD_NAME:"",FIELD_NAMECN:"",SHOW_WIDTH:"",_UUID:generateUUID()};l.push(r);tableIns2.reload({data:l});break;case"delData":var l=a.cache[d];var i=t.data;e:for(var n=l.length-1,o;n>=0;n--){for(j=0;j<i.length;j++){if(l[n].FIELD_NAME==i[j].FIELD_NAME&&l[n]._UUID==i[j]._UUID){l.splice(n,1);continue e}}}tableIns2.reload({data:l});break;case"toTop":var l=a.cache[d];var i=t.data;if(i.length>1){alert("只能选择一项!");return false}if(i.length==0){alert("请选择一项!");return false}var s=true;for(var n=0;n<l.length;n++){if(l[n].FIELD_NAME==i[0].FIELD_NAME&&l[n]._UUID==i[0]._UUID){if(l[n-1]&&s){var c=null;c=l[n];l[n]=l[n-1];l[n-1]=c;s=false}}}tableIns2.reload({data:l});break;case"toBottom":var l=a.cache[d];var i=t.data;if(i.length>1){alert("只能选择一项!");return false}if(i.length==0){alert("请选择一项!");return false}var s=true;for(var n=0;n<l.length;n++){if(l[n].FIELD_NAME==i[0].FIELD_NAME&&l[n]._UUID==i[0]._UUID){if(l[n+1]&&s){var c=null;c=l[n];l[n]=l[n+1];l[n+1]=c;s=false}}}tableIns2.reload({data:l});break;case"getJson":var i=getJsonData();if(i||i.length==0)alert(i);break}});a.on("edit(leftTable)",function(e){var t=a.cache[d];var l=e.data.FIELD_NAME;var r=null;for(var i=0;i<t.length;i++){if(t[i].FIELD_NAME.toUpperCase()==l.toUpperCase()){if(r==null){r=l;continue}else if(r.toUpperCase()==t[i].FIELD_NAME.toUpperCase()){alert("字段名重复,请重新填写!");t.splice(i,1);var n=e.data;n.FIELD_NAME=null;t.push(n)}}}});initFiledData();tableTrClick()})});function addClickData(e){layui.use(["jquery","table","layer"],function(){var a=layui.$,t=layui.table;var l=t.cache[layTableId];var r=e.FIELD_NAME;var i=e.FIELD_NAMECN;var n=e.FIELD_TYPE;var o=e.SUPERFIELD_NAME;var d=null;for(var s=0;s<l.length;s++){if(l[s].FIELD_NAME==r){alert("【"+r+"】字段已经存在,请勿重复添加!");return false}}var c={FIELD_NAME:r,FIELD_NAMECN:i,SHOW_WIDTH:d,_UUID:generateUUID(),FIELD_TYPE:n,SUPERFIELD_NAME:o};l.push(c);tableIns2.reload({data:l})})}function initFiledData(){var e=oldTableColumns;if(e&&e!=""){var a=JSON.parse(e);for(let e=0;e<a.length;e++){if(typeof a[e]!="object"){a=[];break}}tableIns2.reload({data:a})}}function getTableFieldData(){var e="字段信息查询异常";var a=parent.$DS.util.getProjectName();if(source.sourceType=="sqlData"){var t=a+"/sysconfig/frame/selectFactorsBySQL";var l={sql:parent.$DS.util.replace(source.sql)}}else{var t=a+"/console/menup/selectFactors";var l={tableName:source.tableName,appId:source.appId?source.appId:parent.VUECFG.appId}}var r=YCDCommon.Ajax.syncAjax(t,l);if(!r){alert("【"+e+"】系统错误!");console.error("【"+e+"】系统错误!")}if(r.isError){if(!noTip){alert("【"+e+"】"+r.errMsg)}console.error("【"+e+"】"+r.errMsg)}return r.result}function addDimClass(){$("#right_Table .layui-table tbody tr").addClass("drag");$(".layui-table-box,.layui-table-body,.layui-table-body .layui-table").css("position","static");$(".drag").draggable({cursor:"pointer",scroll:false,helper:"clone"})}function addBusClass(){$("#left_Table .layui-table-body").addClass("drop");$(".drop").droppable({drop:function(e,a){layui.use(["jquery","table","layer"],function(){var e=layui.$,t=layui.table;var l=t.cache[layTableId];var r=a.helper[0].children[1].innerText;var i=a.helper[0].children[2].innerText;var n=a.helper[0].children[4].innerText;var o=a.helper[0].children[5].innerText;var d="";for(var s=0;s<l.length;s++){if(l[s].FIELD_NAME==r){alert("【"+r+"】字段已经存在,请勿重复拖拽!");return false}}var c={FIELD_NAME:r,FIELD_NAMECN:i,SHOW_WIDTH:d,_UUID:generateUUID(),FIELD_TYPE:n,SUPERFIELD_NAME:o};l.push(c);tableIns2.reload({data:l})})}})}function getJsonData(){var e=layui.table.cache[layTableId];return JSON.stringify(e)}var saveflag=true;function save(){if(saveflag){saveflag=false;var e=new Loading;e.init({target:document.body});e.start();setTimeout(function(){try{var a=getJsonData();if(a||a.length==0){parent.callBackSelectField(a,key);close_()}}catch(e){parent.alert("操作失败!");console.log(e)}saveflag=true;e.stop()},10)}}