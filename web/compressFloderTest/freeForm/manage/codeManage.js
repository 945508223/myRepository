var ztreeId;function init(){initListCrtlTree();$("#ctrlCodeGrid").datagrid({height:420,singleSelect:true,striped:true,fitColumns:true,data:[],columns:[[{field:"BASENAME",title:"码表类别",halign:"center",width:120,height:50},{field:"CODEN",title:"码表编码",halign:"center",width:120,height:50},{field:"CNAME",title:"码表中文名",halign:"center",width:120,height:50},{field:"PORDER",title:"显示顺序号",halign:"center",align:"right",width:120,height:50}]]})}function initListCrtlTree(){var e={view:{selectedMulti:true},callback:{onClick:getSelectedNode,onAsyncSuccess:expandRootNode},data:{key:{name:"NAME"},simpleData:{enable:true,idKey:"GUID",pIdKey:"PID",rootPId:null}}};var t=findAllNodes();jQuery.fn.zTree.init($("#initListCodeTreeId"),e,t);var r=$.fn.zTree.getZTreeObj("initListCodeTreeId");r.expandAll(true)}function findAllNodes(){var e="select  'root' as guid,'码表类别' as name, null pid ,null basename, 0 corder from dm_form_codecate t   "+"union select t.guid as guid,t.catename as name,'root' as pid,t.basename,t.corder  from dm_form_codecate t  "+"order by pid,corder";var t=$DS.selectBySql(null,e,"查询码表类别信息异常");if(t.isError){alert(t.errMsg);return[]}else{return t.result}}function expandRootNode(e,t,r,d){var i=$.fn.zTree.getZTreeObj(t);var a=i.getNodes();if(a.length>0){for(var l=0;l<a.length;l++){i.expandNode(a[l],true,true,true)}}}function getSelectedNode(e,t,r){ztreeId=r.GUID;var d=r.NAME;var i=r.BASENAME;var a=r.getParentNode();loadPropertyTable(i,d,a)}function loadPropertyTable(e,t,r){var d=$.fn.zTree.getZTreeObj("initListCodeTreeId");var i=d.getSelectedNodes();if(i[0].isParent){$("#ctrlCodeGrid").datagrid("loadData",[])}else{loadCodeGrid(e)}}function loadCodeGrid(e){var t="select * from dm_form_code where basename ='"+e+"' order by porder";var r=$DS.selectBySql(null,t,"查询码表详细信息异常");if(r.isError){alert(r.errMsg);return false}else{r=r.result}$("#ctrlCodeGrid").empty();$("#ctrlCodeGrid").datagrid({height:420,singleSelect:true,striped:true,data:r,columns:[[{field:"BASENAME",title:"码表类别",halign:"center",width:120,height:50},{field:"CODEN",title:"码表编码",halign:"center",width:120,height:50},{field:"CNAME",title:"码表中文名",halign:"center",width:120,height:50},{field:"PORDER",title:"显示顺序号",halign:"center",align:"right",width:120,height:50}]]})}function addCodeCate(){var e=null;showMyDialog("添加码表分类",600,300,"addCodeCate.jsp?update="+e,function(){},"background-color: #fff;font-size:18px;color:#000;")}function updateCodeCate(){var e=$.fn.zTree.getZTreeObj("initListCodeTreeId");var t=e.getSelectedNodes();if(t[0]==undefined){alert("请选择要修改的节点！")}else{var r=t[0].GUID;var d=t[0].BASENAME;var i=t[0].getParentNode();if(i==null){alert("该节点不支持修改，请选择其子节点！")}else{var a="update";showMyDialog("修改码表分类",600,300,"addCodeCate.jsp?baseName="+d+"&guid="+r+"&update="+a,function(){},"background-color: #fff;font-size:18px;color:#000;")}}}function deleteCodeCate(){layer.confirm("确认删除？",{icon:3,title:"提示"},function(){var e=$.fn.zTree.getZTreeObj("initListCodeTreeId");var t=e.getSelectedNodes();if(t.length==0||t[0].isParent){alert("该节点不支持删除，请选择其子节点！");return}var r=$DS.selectBySql(null,"select * from dm_form_code where basename ='"+t[0].BASENAME+"'","查询分类下是否存在码表时出现异常");if(r.isError){alert(r.errMsg);return false}else{r=r.result}if(r!=null&&r.length>0){alert("该类别下存在码表，不能删除！");return}var d=$DS.deleteById(null,"dm_form_codecate","GUID",t[0].GUID,function(e){initListCrtlTree();alert("删除成功!")});if(d.isError){alert(d.errMsg);return false}},function(){})}function addCode(){var e=$.fn.zTree.getZTreeObj("initListCodeTreeId");var t=e.getSelectedNodes();if(t[0]==undefined){alert("请选择要添加码表的节点！");return}else{var r=t[0].GUID;var d=t[0].BASENAME;var i=t[0].getParentNode();if(i==null){alert("该节点不支持添加码表，请选择其子节点！");return}else{showMyDialog("添加码表",600,280,"addCode.jsp?baseName="+d+"&categuid="+r+"&addOrUpdate=add",function(){},"background-color: #27b6e4;font-size:18px;color:#fff;")}}}function updateCode(){var e=$("#ctrlCodeGrid").datagrid("getSelected");var t=$.fn.zTree.getZTreeObj("initListCodeTreeId");var r=t.getSelectedNodes();if(r[0]==undefined){alert("请选择要修改的节点！")}else{var d=r[0].BASENAME;var i=r[0].getParentNode();if(i==null){alert("该节点不支持修改，请选择其子节点！")}else{if(e!=null){var a=e.GUID;showMyDialog("修改码表",600,280,"addCode.jsp?baseName="+d+"&guid="+a+"&addOrUpdate=update",function(){},"background-color: #27b6e4;font-size:18px;color:#fff;")}else{alert("请选择要修改的码表！")}}}}function deleteCode(){layer.confirm("确认删除？",{icon:3,title:"提示"},function(e){layer.close(e);var t=$("#ctrlCodeGrid").datagrid("getSelected");if(t){var r=$DS.deleteById(null,"dm_form_code","GUID",t.GUID,function(e){loadCodeGrid(t.BASENAME);alert("删除成功!")});if(r.isError){alert(r.errMsg);return false}}else{alert("请选择要修删除的节点！");return false}},function(){})}