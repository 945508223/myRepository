var sid=YCDCommon.Win.getUrlParam("sid");var param=window.top[sid];var sourceCols=param.sourceCols;var selectCols=param.selectCols;var ctrlId=param.ctrlId;var tableIns1;var tableIns2;var layTableId="layTable";var base64=new Base64;function isBase64(e){if(e===""||e.trim()===""){return false}try{return btoa(atob(e))==e}catch(e){return false}}$(document).ready(function(){var e=new Array;e.push({name:"确定",onclick:"save",classname:"ycd-icon-ok"});e.push({name:"关闭",onclick:"pageClose",classname:"ycd-icon-cancel"});YCDComponents.toolbar.formToolbar("main1",e);layui.use(["jquery","table","layer"],function(){var e=layui.$,t=layui.table;form=layui.form;layer=layui.layer;var a=getRightTableData();var r="字段中文名";var l=e("#right_Table").width();tableIns1=t.render({elem:"#rightTable",id:"rightTable",height:"full-41",data:a,page:false,limit:1e21,title:"当前表字段:",toolbar:true,defaultToolbar:["filter",{title:"提示",layEvent:"LAYTABLE_TIPS",icon:"layui-icon-tips"}],cols:[[{type:"checkbox",width:.2*l-12},{field:"FIELD_NAME",title:"字段名",width:.4*l},{field:"FIELD_NAMECN",title:"字段中文名",width:.4*l},{field:"SHOW_WIDTH",title:"列宽",hide:true}]],done:function(t,a,r){addDimClass();e("#rightTable").next().find(".layui-table-body").find("table").find("tbody").children("tr").on("dblclick",function(){var a=JSON.stringify(e("#rightTable").next().find(".layui-table-body").find("table").find("tbody").find(".layui-table-hover").data("index"));var r=t.data[a];addClickData(r)})}});var i=e("#left_Table").width();var n=[];var c="layTable";tableIns2=t.render({elem:"#leftTable",id:c,height:"full-41",title:"已选择字段:",toolbar:"#jsonToolbar",defaultToolbar:["filter",{title:"提示",layEvent:"LAYTABLE_TIPS",icon:"layui-icon-tips"}],data:n,page:false,limit:1e21,cols:[[{type:"checkbox",width:.1*i-12,fixed:true},{field:"FIELD_NAME",title:"字段名",width:.25*i,align:"center",edit:"text",fixed:true},{field:"FIELD_NAMECN",title:r,width:.25*i,edit:"text",fixed:true},{field:"SHOW_COMPONENT",title:"是否显示",align:"center",width:.15*i,templet:function(e){var t="";if(e.SHOW_COMPONENT!=="none"&&e.SHOW_COMPONENT!=="hidden"){t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.SHOW_COMPONENT+"' lay-filter='SHOW_COMPONENT' checked='checked' name='SHOW_COMPONENT'  lay-skin='switch'  >"}else{t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.SHOW_COMPONENT+"' lay-filter='SHOW_COMPONENT'  name='SHOW_COMPONENT'  lay-skin='switch' >"}return t}},{field:"SHOW_WIDTH",title:"显示宽度",width:.15*i,align:"center",edit:"text"},{field:"DEFAULT_VALUE",title:"缺省值",width:.15*i,align:"center",edit:"text"},{field:"DATETYPE ",title:"日期控件类型",align:"center",width:.15*i,hide:true,templet:function(e){var t=[{name:"datetime",value:"datetime"},{name:"year",value:"year"},{name:"month",value:"month"},{name:"date",value:"date"},{name:"week",value:"week"}];var a=getSelectModel(t,"DATETYPE",e);return a}},{field:"DATE_FORMATER",title:"格式化日期",align:"center",edit:"text",width:.15*i,hide:true},{field:"isedit",title:"是否可编辑",align:"center",hide:true,width:.15*i,templet:function(e){var t="";if(e.isedit!==false){t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.isedit+"' lay-filter='isedit' checked='checked' name='isedit'  lay-skin='switch'  >"}else{t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.isedit+"' lay-filter='isedit'  name='isedit'  lay-skin='switch' >"}return t}},{field:"CHECKREGULAR",title:"值变更校验",align:"center",width:.2*i,hide:true,templet:function(e){let t=e.CHECKREGULAR?"【正则校验】":"";var a=JSON.stringify(e.CHECKREGULAR?e.CHECKREGULAR:{});return`<input uuid="${e._UUID}" style="border-width: 0px" class="hh ww text-cz" onfocus="openRegularSetting(this)" checkregular="${a}" value=${t}></input>`}},{field:"FIELD_DECLENGTH",title:"保留小数位数",align:"center",edit:"text",width:.15*i},{field:"ADD_THOUSANDS",title:"是否添加千分符",align:"center",width:.15*i,templet:function(e){var t="";if(e.ADD_THOUSANDS){t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ADD_THOUSANDS' checked='checked' name='ADD_THOUSANDS'  lay-skin='switch'  >"}else{t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ADD_THOUSANDS'  name='ADD_THOUSANDS'  lay-skin='switch' >"}return t}},{field:"ISEXPEND",title:"是否展开",align:"center",width:.15*i,hide:true,templet:function(e){var t="";if(e.ISEXPEND){t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ISEXPEND' checked='checked' name='ISEXPEND'  lay-skin='switch'  >"}else{t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ISEXPEND'  name='ISEXPEND'  lay-skin='switch' >"}return t}},{field:"EXPENDWIDTH",title:"展开行宽度",align:"center",edit:"text",width:.15*i,hide:true},{field:"ISFILTERED",title:"是否过滤",align:"center",width:.15*i,templet:function(e){var t="";if(e.ISFILTERED){t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ISFILTERED' checked='checked' name='ISFILTERED'  lay-skin='switch'  >"}else{t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ISFILTERED'  name='ISFILTERED'  lay-skin='switch' >"}return t}},{field:"ISSUM",title:"是否求和",align:"center",width:.15*i,templet:function(e){var t="";if(e.ISSUM=="1"){t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ISSUM' checked='checked' name='ISSUM'  lay-skin='switch'  >"}else{t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ISSUM'  name='ISSUM'  lay-skin='switch' >"}return t}},{field:"ISMERGECOL",title:"是否合并列",align:"center",width:.15*i,templet:function(e){var t="";if(e.ISMERGECOL){t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.ISMERGECOL+"' lay-filter='ISMERGECOL' checked='checked' name='ISMERGECOL'  lay-skin='switch'  >"}else{t="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.ISMERGECOL+"' lay-filter='ISMERGECOL'  name='ISMERGECOL'  lay-skin='switch' >"}return t}},{field:"ALIGNTYPE ",title:"对齐方式",align:"center",width:.15*i,templet:function(e){var t=[{name:"居左",value:"left"},{name:"居中",value:"center"},{name:"居右",value:"right"}];var a=getSelectModel(t,"ALIGNTYPE",e);return a}},{field:"SUPERFIELD_NAME",title:"上级字段",width:.15*i,align:"center",edit:"text"},{field:"CUSTOMHTML",title:"自定义HTML",width:.15*i,align:"center",templet:function(e){let t=e.CUSTOMHTML?"【HTML】":"";var a=e.CUSTOMHTML?e.CUSTOMHTML:"";if(a&&!isBase64(a)){a=base64.encode(e.CUSTOMHTML)}return`<input uuid="${e._UUID}" style="border-width: 0px" class="hh ww text-cz" onfocus="openHtmlEditor(this)" htmlStr="${a}" value=${t}></input>`}},{field:"FK_FILTER_SQL",title:"引用数据过滤条件(例: FIELDA>0 AND FIELDB>0)",width:.3*i,align:"center",edit:"text",hide:true},{field:"FK_FILTER_ROWDATA",title:"根据行过滤引用数据(例: row.FIELDA-=-XXX1|label-like-XXX2)",width:.3*i,align:"center",edit:"text",hide:true}]],done:function(e,t,a){showTableStyle(e,t,a);addBusClass()}});t.on("toolbar(leftTable)",function(e){var a=t.checkStatus(e.config.id);switch(e.event){case"insertData":var r=t.cache[c];var l={FIELD_NAME:"",FIELD_NAMECN:"",SHOW_WIDTH:"",ISEXPEND:false,SHOW_COMPONENT:"input",ADD_THOUSANDS:false,ALIGNTYPE:"left",FIELD_DECLENGTH:"",DEFAULT_VALUE:"",DATE_FORMATER:"",DATETYPE:"date",_UUID:generateUUID(),ISFILTERED:false,ISSUM:false,EXPENDWIDTH:"100%",SUPERFIELD_NAME:"#"};r.push(l);tableIns2.reload({data:r});break;case"delData":var r=t.cache[c];var i=a.data;e:for(var n=r.length-1,o;n>=0;n--){for(j=0;j<i.length;j++){if(r[n].FIELD_NAME==i[j].FIELD_NAME&&r[n]._UUID==i[j]._UUID){r.splice(n,1);continue e}}}tableIns2.reload({data:r});break;case"toTop":var r=t.cache[c];var i=a.data;if(i.length>1){alert("只能选择一项!");return false}if(i.length==0){alert("请选择一项!");return false}var d=true;for(var n=0;n<r.length;n++){if(r[n].FIELD_NAME==i[0].FIELD_NAME&&r[n]._UUID==i[0]._UUID){if(r[n-1]&&d){var E=null;E=r[n];r[n]=r[n-1];r[n-1]=E;d=false}}}tableIns2.reload({data:r});break;case"toBottom":var r=t.cache[c];var i=a.data;if(i.length>1){alert("只能选择一项!");return false}if(i.length==0){alert("请选择一项!");return false}var d=true;for(var n=0;n<r.length;n++){if(r[n].FIELD_NAME==i[0].FIELD_NAME&&r[n]._UUID==i[0]._UUID){if(r[n+1]&&d){var E=null;E=r[n];r[n]=r[n+1];r[n+1]=E;d=false}}}tableIns2.reload({data:r});break;case"getJson":var i=getJsonData();if(i||i.length==0)alert(i);break}});t.on("edit(leftTable)",function(e){var a=t.cache[c];var r=e.data.FIELD_NAME;var l=null;for(var i=0;i<a.length;i++){if(a[i].FIELD_NAME.toUpperCase()==r.toUpperCase()){if(l==null){l=r;continue}else if(l.toUpperCase()==a[i].FIELD_NAME.toUpperCase()){alert("字段名重复,请重新填写!");a.splice(i,1);var n=e.data;n.FIELD_NAME=null;a.push(n)}}}});form.on("switch(ISEXPEND)",function(a){var r=a.elem.checked;var l=t.cache[c];var i=e(a.elem).attr("uuid");var n=a.elem.checked;for(var o=0;o<l.length;o++){if(l[o]._UUID==i){l[o]["ISEXPEND"]=n}}t.cache[c]=l;form.render()});form.on("switch(SHOW_COMPONENT)",function(a){var r=t.cache[c];var l=e(a.elem).attr("uuid");var i=a.elem.checked;var n=a.elem.value;for(var o=0;o<r.length;o++){if(r[o]._UUID==l){if(i===false){r[o]["SHOW_COMPONENT"]="hidden"}else{var d=sourceCols.map(e=>{return e.FIELD_NAME});if(d.indexOf(r[o].FIELD_NAME)!==-1){for(let e=0;e<sourceCols.length;e++){if(r[o].FIELD_NAME==sourceCols[e].FIELD_NAME){if(sourceCols[e].SHOW_COMPONENT=="hidden"||sourceCols[e].SHOW_COMPONENT=="none"){r[o]["SHOW_COMPONENT"]="input"}else{r[o]["SHOW_COMPONENT"]=sourceCols[e].SHOW_COMPONENT}break}}}else{r[o]["SHOW_COMPONENT"]="input"}}break}}t.cache[c]=r;form.render()});form.on("switch(ISMERGECOL)",function(a){var r=t.cache[c];var l=e(a.elem).attr("uuid");var i=a.elem.checked;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){r[n]["ISMERGECOL"]=i;break}}t.cache[c]=r;form.render()});form.on("switch(isedit)",function(a){var r=t.cache[c];var l=e(a.elem).attr("uuid");var i=a.elem.checked;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){r[n]["isedit"]=i;break}}t.cache[c]=r;form.render()});form.on("switch(ADD_THOUSANDS)",function(a){var r=t.cache[c];var l=e(a.elem).attr("uuid");var i=a.elem.checked;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){r[n]["ADD_THOUSANDS"]=i;break}}t.cache[c]=r;form.render()});form.on("switch(ISFILTERED)",function(a){var r=t.cache[c];var l=e(a.elem).attr("uuid");var i=a.elem.checked;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){r[n]["ISFILTERED"]=i;break}}t.cache[c]=r;form.render()});form.on("switch(ISSUM)",function(a){var r=t.cache[c];var l=e(a.elem).attr("uuid");var i=a.elem.checked;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){r[n]["ISSUM"]=i==true?"1":"0";break}}t.cache[c]=r;form.render()});form.on("select(DATETYPE)",function(a){var r=a.value;var l=t.cache[c];var i=e(a.elem).attr("uuid");for(var n=0;n<l.length;n++){if(l[n]._UUID==i){l[n].DATETYPE=r;break}}e(a.elem).attr("value",r);t.cache[c]=l;form.render()});form.on("select(ALIGNTYPE)",function(a){var r=a.value;var l=t.cache[c];var i=e(a.elem).attr("uuid");for(var n=0;n<l.length;n++){if(l[n]._UUID==i){l[n].ALIGNTYPE=r;break}}e(a.elem).attr("value",r);t.cache[c]=l;form.render()});form.on("switch(ISTITLE)",function(a){var r=t.cache[c];var l=e(a.elem).attr("uuid");var i=a.elem.checked;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){r[n]["ISTITLE"]=i;break}}t.cache[c]=r;form.render()});initFiledData();tableTrClick()})});function addClickData(e){layui.use(["jquery","table","layer"],function(){var t=layui.$,a=layui.table;var r=a.cache[layTableId];var l=e.FIELD_NAME;var i=e.FIELD_NAMECN;var n=e.FIELD_TYPE;var c=e.SUPERFIELD_NAME;var o=e.SHOW_COMPONENT;var d=e.ALIGNTYPE;var E=e.ADD_THOUSANDS;var u=null;var s=e.DATE_FORMATER;var f=e.DATETYPE;var h=e.CUSTOMHTML;var D=e.CHECKREGULAR;var I=e.FK_FILTER_ROWDATA;var v=e.FK_FILTER_SQL;for(var T=0;T<r.length;T++){if(r[T].FIELD_NAME==l){alert("【"+l+"】字段已经存在,请勿重复添加!");return false}}var _={FIELD_NAME:l,FIELD_NAMECN:i,SHOW_WIDTH:u,_UUID:generateUUID(),FIELD_TYPE:n,SUPERFIELD_NAME:c,CUSTOMHTML:h,CHECKREGULAR:D,FK_FILTER_ROWDATA:I,FK_FILTER_SQL:v,SHOW_COMPONENT:o,ALIGNTYPE:d,ADD_THOUSANDS:E,DATE_FORMATER:s,DATETYPE:f};r.push(_);tableIns2.reload({data:r})})}function initFiledData(){var e=selectCols;if(e&&e.length>0){var t=getTableData(e);for(let e=0;e<t.length;e++){if(!t[e]._UUID){t[e]["_UUID"]=generateUUID()}}tableIns2.reload({data:t})}}function getRightTableData(){return getTableData(sourceCols)}function getTableData(e){var t=[];if(e&&e.length>0&&e[0].id&&e[0].label&&e[0].prop){t=formatOldData(e)}else{for(let i=0;i<e.length;i++){var a=e[i];var r=formatObj(a);t.push(r);if(a.children&&a.children.length>0){var l=[];parseChildrenData(a.children,l);t=t.concat(l)}}}return t}function parseChildrenData(e,t){var a=[];for(let a=0;a<e.length;a++){var r=e[a];var l=formatObj(r);t.push(l);if(r.children&&r.children.length>0){parseChildrenData(r.children,t)}}}function formatOldData(e){var t=e.map(e=>{var t={};t["FIELD_NAME"]=e.id;t["FIELD_NAMECN"]=e.label;t["SHOW_WIDTH"]=e.width;t["ISEXPEND"]=e.isexpend;t["SHOW_COMPONENT"]=e.fieldShowType;t["ISMERGECOL"]=e.ISMERGECOL;t["isedit"]=e.isedit;t["FIELD_TYPE"]=e.FIELD_TYPE;t["ALIGNTYPE"]=e.ALIGNTYPE;t["ISFILTERED"]=e.ISFILTERED;t["ISSUM"]=e.ISSUM;return t});return t}function formatObj(e){var t={};for(var a in e){switch(a){case"FIELD_TYPE":t.FIELD_TYPE=e[a];break;case"FIELD_NAME":t.FIELD_NAME=e[a];break;case"FIELD_NAMECN":t.FIELD_NAMECN=e[a];break;case"SHOW_WIDTH":t.SHOW_WIDTH=e[a];break;case"ISEXPEND":t.ISEXPEND=e[a];break;case"SHOW_COMPONENT":t.SHOW_COMPONENT=e[a];break;case"ISMERGECOL":t.ISMERGECOL=e[a];break;case"isedit":t.isedit=e[a];break;case"ALIGNTYPE":t.ALIGNTYPE=e[a];break;case"ADD_THOUSANDS":t.ADD_THOUSANDS=e[a];break;case"FIELD_DECLENGTH":t.FIELD_DECLENGTH=e[a];break;case"ISFILTERED":t.ISFILTERED=e[a];break;case"DATE_FORMATER":t.DATE_FORMATER=e[a];break;case"DATETYPE":t.DATETYPE=e[a];break;case"DEFAULT_VALUE":t.DEFAULT_VALUE=e[a];break;case"ISTITLE":t.ISTITLE=e[a];break;case"SUPERFIELD_NAME":t.SUPERFIELD_NAME=e[a];break;case"ISSUM":t.ISSUM=e[a];break;case"EXPENDWIDTH":t.EXPENDWIDTH=e[a];break;case"CUSTOMHTML":t.CUSTOMHTML=e[a];break;case"FK_FILTER_ROWDATA":t.FK_FILTER_ROWDATA=e[a];break;case"FK_FILTER_SQL":t.FK_FILTER_SQL=e[a];break;case"CHECKREGULAR":t.CHECKREGULAR=e[a];break;CHECKREGULAR}}return t}function addDimClass(){$("#right_Table .layui-table tbody tr").addClass("drag");$(".layui-table-box,.layui-table-body,.layui-table-body .layui-table").css("position","static");$(".drag").draggable({cursor:"pointer",scroll:false,helper:"clone"})}function showTableStyle(){$("#left_Table").find("td").each(function(){$("#left_Table td .layui-form-select").each(function(){$(this).parent().css("overflow","visible")})});$("#left_Table").find("th").each(function(){let e=$(this).find("span").text();$(this).attr("title",e)})}function addBusClass(){$("#left_Table .layui-table-body").addClass("drop");$(".drop").droppable({drop:function(e,t){layui.use(["jquery","table","layer"],function(){var e=layui.$,a=layui.table;var r=a.cache[layTableId];var l=t.helper[0].children[1].innerText;var i=t.helper[0].children[2].innerText;var n=t.helper[0].children[3].innerText;var c="";for(var o=0;o<r.length;o++){if(r[o].FIELD_NAME==l){alert("【"+l+"】字段已经存在,请勿重复拖拽!");return false}}var d={FIELD_NAME:l,FIELD_NAMECN:i,SHOW_WIDTH:c,_UUID:generateUUID()};r.push(d);tableIns2.reload({data:r})})}})}function getJsonData(){var e=layui.table.cache[layTableId];return JSON.stringify(e)}function findColItemByFieldName(e,t){for(let a=0;a<e.length;a++){if(e[a].prop===t)return e[a];else if(e[a].children&&e[a].children.length>0){return findColItemByFieldName(e[a].children,t)}}}function getSaveData(){return layui.table.cache[layTableId]}var saveflag=true;function save(){var e=getSaveData();var t=checkData(e);if(!t){return}if(saveflag){saveflag=false;var a=new Loading;a.init({target:document.body});a.start();setTimeout(function(){try{if(e&&e.length>0){parent.callBackSelectGridField(e,ctrlId);close_()}else{alert("请至少选择一列!")}}catch(e){parent.alert("操作失败!");console.log(e)}saveflag=true;a.stop()},10)}}function checkData(e){var t={};var a=[];for(let e=0;e<sourceCols.length;e++){t[sourceCols[e].FIELD_NAME]=sourceCols[e]}for(let r=0;r<e.length;r++){if(!t[e[r].FIELD_NAME]){continue}if(hasChildrenCol(e[r],e)&&e[r].FIELD_TYPE!=="004"){a.push(e[r].FIELD_NAMECN)}}if(a.length>0){var r=a.join(",");alert("【"+r+" 不为标题列,请检查字段配置 】");return false}return true}function hasChildrenCol(e,t){for(let a=0;a<t.length;a++){if(e.FIELD_NAME==t[a].SUPERFIELD_NAME){return true}}return false}function getSelectModel(e,t,a){var r="";var l="";for(var i=0;i<e.length;i++){l+=YCDCommon.temp("model_option",{text:e[i].name,value:e[i].value,checked:a[t]==e[i].value?"selected":""})}r=YCDCommon.temp("model_select",{name:t,uuid:a._UUID,option:l,value:a[t],layFilter:t});return r}function openHtmlEditor(e){var t=Date.parse(new Date);var a=$(e).attr("htmlStr")?$(e).attr("htmlStr"):"\x3c!--可使用 ${V.customRow.xxx} 获取本行的某个字段值--\x3e";if(a&&isBase64(a)){a=base64.decode(a)}window.top[t]={html:a,callback:function(t){var a=getSaveData();var r=$(e).attr("uuid");for(var l=0;l<a.length;l++){if(a[l]._UUID==r){a[l]["CUSTOMHTML"]=base64.encode(t);break}}tableIns2.reload({data:a})}};showMyDialog("编辑HTML","100%","100%",getProjectName()+"/freeForm/js/editor/online_editor/htmlEditor.jsp?htmlStr=1&key="+t,function(){})}function openRegularSetting(e){var t=Date.parse(new Date);var a=[{edit:"text",field:"expression",title:"正则表达式",width:.5},{edit:"text",field:"errMsg",title:"错误提示",width:.5}];var r=getSaveData();var l=$(e).attr("uuid");let i;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){i=r[n]["CHECKREGULAR"];break}}window.top[t]={col:a,value:i,callback:function(t,a){debugger;var l=$(e).attr("uuid");for(var i=0;i<r.length;i++){if(r[i]._UUID==l){r[i]["CHECKREGULAR"]=t;break}}tableIns2.reload({data:r})}};showMyDialog("设置正则","100%","100%",getProjectName()+"/freeForm/js/editor/commonTable.jsp?&key="+t,function(){})}