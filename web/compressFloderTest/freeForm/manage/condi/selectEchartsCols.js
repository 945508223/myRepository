window.onload=function(){window["selectDMVm"]=new Vue({el:"#app",data:{param:{},props:{children:"children",label:"label"},draggable:true,draggingNode:"",enterData:"",treeData:[],DIMENSION:[],MEASURE:[]},created(){this.initData();this.$nextTick(function(){})},computed:{selectedObj:function(){let e={};let t=this.DIMENSION.concat(this.MEASURE);for(let r of t){e[r.FIELD_NAME]=r}return e}},methods:{initData:initData,allowDrop:allowDrop,treeNodeDragStart:treeNodeDragStart,treeNodeDragOver:treeNodeDragOver,treeNodeDragEnd:treeNodeDragEnd,dropDM:dropDM,dropDMdragStart:dropDMdragStart,dropDMdragEnd:dropDMdragEnd,dropDMdragEnter:dropDMdragEnter,handleDMCommand:handleDMCommand,close:function(){close_()},save:save}})};function initData(){try{var e=YCDCommon.Win.getUrlParam("sid");var t=window.top[e];this.param=t;var r=t.sourceCols;for(let e of r){e["label"]=e.FIELD_NAMECN}this.treeData=r;var a=t.selectCols;let n=0;let o=0;for(let e of a){if(e.DIMENSION&&e.DIMENSION==="DIMENSION"){e["dimensionIndex"]=n;this.DIMENSION.push(e);n++}if(e.DIMENSION&&e.DIMENSION==="MEASURE"){e["measureIndex"]=o;this.MEASURE.push(e);o++}}}catch(e){console.error(e)}}function allowDrop(e,t,r){return false}function treeNodeDragStart(e,t){e.data["dragType"]="newDrag";this.draggingNode=e}function treeNodeDragOver(e){}function treeNodeDragEnd(e,t,r,a){this.draggingNode="";this.enterData=""}function dropDMdragStart(e){this.selectedObj[$(e.target).attr("field-name")]["dragType"]="sortDrag";this.draggingNode={data:this.selectedObj[$(e.target).attr("field-name")]}}function dropDMdragEnter(e,t){this["enterData"]=e}function dropDMdragEnd(e){this.draggingNode="";this.enterData=""}function dropDM(e){debugger;if(this.draggingNode&&this.draggingNode.data&&this.draggingNode.data.dragType==="newDrag"){createdNewDMNode(this.draggingNode,this.DIMENSION,this.MEASURE,this.enterData,e)}else if(this.draggingNode&&this.draggingNode.data&&this.draggingNode.data.dragType==="sortDrag"&&this.enterData){dragDMNode(this.draggingNode,this.enterData,e)}}function createdNewDMNode(e,t,r,a,n){let o=t.concat(r);for(let t of o){if(t.FIELD_NAME===e.data.FIELD_NAME){alert("该字段已被设置!");return false}}let d="";if($(n.currentTarget).attr("id")=="dropDimension"){d="DIMENSION"}else if($(n.currentTarget).attr("id")=="dropMeasure"){d="MEASURE"}let i=parent.$DS.util.clone(e.data);i["DIMENSION"]=d;delete i.dragType;let s=d.toLowerCase()+"Index";let l=d=="DIMENSION"?t:r;if(a&&a.FIELD_NAME!==e.data.FIELD_NAME){i[s]=a[s];for(let e=a[s];e<l.length;e++){l[e][s]++}l.push(i);l=sortDMItem(l,s);window.selectDMVm[d]=l}else{i[s]=l.length;window.selectDMVm[d].push(i)}}function dragDMNode(e,t,r){let a=$(r.currentTarget).attr("id").split("drop")[1].toUpperCase();delete e.data.dragType;if(e.data.DIMENSION===a){let r=e.data.DIMENSION;let a=window.selectDMVm[r];let n=r.toLowerCase()+"Index";let o=t[n];for(let r of a){if(r.FIELD_NAME===e.data.FIELD_NAME){let e=r[n];let a=t[n];[e,a]=[a,e];r[n]=e;t[n]=a;break}}a.sort(function(e,t){var r=e[n];var a=t[n];if(r<a){return-1}else if(r>a){return 1}else{return 0}});window.selectDMVm[r]=a}else if(e.data.DIMENSION!==a){return false}}function sortDMchange(e,t,r,a){let n=parent.$DS.util.clone(e.data);let o=e.data.hasOwnProperty("measureIndex")?"MEASURE":"DIMENSION";let d=window.selectDMVm[o];let i=window.selectDMVm[r];delete n[o.toLowerCase()+"Index"];n["DIMENSION"]=r;d=d.filter(t=>t.FIELD_NAME!==e.data.FIELD_NAME);d=d.map((e,t)=>{e[o.toLowerCase()+"Index"]=t;return e});if(t&&t.FIELD_NAME!==e.data.FIELD_NAME){n[r.toLowerCase()+"Index"]=t[r.toLowerCase()+"Index"];for(let e=t[r.toLowerCase()+"Index"];e<i.length;e++){i[e][r.toLowerCase()+"Index"]++}i.push(n);i.sort(function(e,t){var a=e[r.toLowerCase()+"Index"];var n=t[r.toLowerCase()+"Index"];if(a<n){return-1}else if(a>n){return 1}else{return 0}})}else{n[r.toLowerCase()+"Index"]=i.length;i.push(n)}window.selectDMVm[o]=d;window.selectDMVm[r]=i}function sortDMItem(e,t){e.sort(function(e,r){var a=e[t];var n=r[t];if(a<n){return-1}else if(a>n){return 1}else{return 0}});return e}function save(){try{if(this.param["saveFun"]){this.param.win=window;this.param["saveFun"](this.DIMENSION.concat(this.MEASURE),this.param)}else{parent.$DS.getCtrlById(this.param["ctrlId"]).info.ds_selectcolumns=this.DIMENSION.concat(this.MEASURE);if(parent.temporary.echarsCtrlDM){delete parent.temporary.echarsCtrlDM[this.param["ctrlId"]]}parent.$DS.refPro();close_()}}catch(e){alert("保存失败!");console.error(e)}}function handleDMCommand(e){debugger;let t=e.split("-")[0];let r=e.split("-")[1];let a=e.split("-")[2];if(t==="delete"){deleteDM(a,r)}else if(t==="setting"){settingDM(this.selectedObj[a],r)}}function deleteDM(e,t){let r=window.selectDMVm;r[t]=r[t].filter(t=>t.FIELD_NAME!==e);r[t]=r[t].map((e,r)=>{e[t.toLowerCase()+"Index"]=r;return e})}function settingDM(e,t){if(t==="MEASURE"){let t=Date.parse(new Date);let a={info:e,callback:function(e,t){debugger;console.log(e)}};window.top[t]=a;var r=parent.$DS.util.getProjectName()+"/freeForm/manage/condi/chartMeasureSet.html?key="+t;parent.$DS.showPage(r,"设置度量","40%","80%","",false)}}