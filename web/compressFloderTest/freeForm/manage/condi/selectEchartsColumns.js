var sid=YCDCommon.Win.getUrlParam("sid");var param=window.top[sid];var sourceCols=param.sourceCols;var selectCols=param.selectCols;var ctrlId=param.ctrlId;var tableIns1;var tableIns2;var layTableId="layTable";$(document).ready(function(){var e=new Array;e.push({name:"确定",onclick:"save",classname:"ycd-icon-ok"});e.push({name:"关闭",onclick:"pageClose",classname:"ycd-icon-cancel"});YCDComponents.toolbar.formToolbar("main1",e);layui.use(["jquery","table","layer"],function(){var e=layui.$,a=layui.table;form=layui.form;layer=layui.layer;var t=getRightTableData();var r="字段中文名";var l=e("#right_Table").width();tableIns1=a.render({elem:"#rightTable",id:"rightTable",height:"full-41",data:t,page:false,limit:1e21,title:"当前表字段:",toolbar:true,defaultToolbar:["filter",{title:"提示",layEvent:"LAYTABLE_TIPS",icon:"layui-icon-tips"}],cols:[[{type:"checkbox",width:.2*l-12},{field:"FIELD_NAME",title:"字段名",width:.4*l},{field:"FIELD_NAMECN",title:"字段中文名",width:.4*l},{field:"SHOW_WIDTH",title:"列宽",hide:true}]],done:function(a,t,r){debugger;addDimClass();e("#rightTable").next().find(".layui-table-body").find("table").find("tbody").children("tr").on("dblclick",function(){var t=JSON.stringify(e("#rightTable").next().find(".layui-table-body").find("table").find("tbody").find(".layui-table-hover").data("index"));var r=a.data[t];addClickData(r)})}});var i=e("#left_Table").width();var n=[];var o="layTable";var d=parent.$DS.getCtrlType(ctrlId)=="pie"?true:false;tableIns2=a.render({elem:"#leftTable",id:o,height:"full-41",title:"已选择字段:",toolbar:"#jsonToolbar",defaultToolbar:["filter",{title:"提示",layEvent:"LAYTABLE_TIPS",icon:"layui-icon-tips"}],data:n,page:false,limit:1e21,cols:[[{type:"checkbox",width:.1*i-12,fixed:true},{field:"FIELD_NAME",title:"字段名",width:.25*i,align:"center",edit:"text",fixed:true},{field:"FIELD_NAMECN",title:r,width:.25*i,edit:"text",fixed:true},{field:"DIMENSION ",title:"选择维度",align:"center",width:.15*i,templet:function(e){debugger;var a=[{name:"无",value:"EMPTY"},{name:"维度",value:"DIMENSION"},{name:"度量",value:"MEASURE"}];var t=getSelectModel(a,"DIMENSION",e);return t}},{field:"INDEX",title:"排序",width:.25*i,edit:"text",fixed:false},{field:"FIELD_DECLENGTH",title:"保留小数位数",align:"center",edit:"text",width:.15*i},{field:"ADD_THOUSANDS",title:"是否添加千分符",align:"center",width:.15*i,hide:true,templet:function(e){var a="";if(e.ADD_THOUSANDS){a="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ADD_THOUSANDS' checked='checked' name='ADD_THOUSANDS'  lay-skin='switch'  >"}else{a="<input uuid='"+e._UUID+"' type='checkbox' value='"+e.id+"' lay-filter='ADD_THOUSANDS'  name='ADD_THOUSANDS'  lay-skin='switch' >"}return a}},{field:"TENTHOUSAND ",title:"单位",align:"center",width:.15*i,templet:function(e){debugger;var a=[{name:"无",value:"EMPTY"},{name:"百分数",value:"0"},{name:"万元",value:"1"},{name:"十万元",value:"2"},{name:"百万元",value:"3"},{name:"千万元",value:"4"},{name:"亿元",value:"5"}];var t=getSelectModel(a,"TENTHOUSAND",e);return t}},{field:"YAXIS ",title:"Y轴",align:"center",width:.15*i,hide:d,templet:function(e){debugger;var a=[{name:"左Y轴",value:"left"},{name:"右Y轴",value:"right"}];var t=getSelectModel(a,"YAXIS",e);return t}}]],done:function(e,a,t){showTableStyle(e,a,t);addBusClass()}});a.on("toolbar(leftTable)",function(e){var t=a.checkStatus(e.config.id);debugger;switch(e.event){case"insertData":var r=a.cache[o];var l={FIELD_NAME:"",FIELD_NAMECN:"",DIMENTION:"",INDEX:""};r.push(l);tableIns2.reload({data:r});break;case"delData":var r=a.cache[o];var i=t.data;e:for(var n=r.length-1,d;n>=0;n--){for(j=0;j<i.length;j++){if(r[n].FIELD_NAME==i[j].FIELD_NAME&&r[n]._UUID==i[j]._UUID){r.splice(n,1);continue e}}}tableIns2.reload({data:r});break;case"toTop":var r=a.cache[o];var i=t.data;if(i.length>1){alert("只能选择一项!");return false}if(i.length==0){alert("请选择一项!");return false}var c=true;for(var n=0;n<r.length;n++){if(r[n].FIELD_NAME==i[0].FIELD_NAME&&r[n]._UUID==i[0]._UUID){if(r[n-1]&&c){var u=null;u=r[n];r[n]=r[n-1];r[n-1]=u;c=false}}}tableIns2.reload({data:r});break;case"toBottom":var r=a.cache[o];var i=t.data;if(i.length>1){alert("只能选择一项!");return false}if(i.length==0){alert("请选择一项!");return false}var c=true;for(var n=0;n<r.length;n++){if(r[n].FIELD_NAME==i[0].FIELD_NAME&&r[n]._UUID==i[0]._UUID){if(r[n+1]&&c){var u=null;u=r[n];r[n]=r[n+1];r[n+1]=u;c=false}}}tableIns2.reload({data:r});break;case"getJson":var i=getJsonData();if(i||i.length==0)alert(i);break}});a.on("edit(leftTable)",function(e){var t=a.cache[o];var r=e.data.FIELD_NAME;var l=null;for(var i=0;i<t.length;i++){if(t[i].FIELD_NAME.toUpperCase()==r.toUpperCase()){if(l==null){l=r;continue}else if(l.toUpperCase()==t[i].FIELD_NAME.toUpperCase()){alert("字段名重复,请重新填写!");t.splice(i,1);var n=e.data;n.FIELD_NAME=null;t.push(n)}}}if(l!=null){tableIns2.reload({data:t})}});form.on("select(DIMENSION)",function(t){debugger;var r=t.value;var l=a.cache[o];var i=e(t.elem).attr("uuid");for(var n=0;n<l.length;n++){if(l[n]._UUID==i){l[n].DIMENSION=r;break}}e(t.elem).attr("value",r);a.cache[o]=l;form.render()});form.on("switch(ADD_THOUSANDS)",function(t){var r=a.cache[o];var l=e(t.elem).attr("uuid");var i=t.elem.checked;for(var n=0;n<r.length;n++){if(r[n]._UUID==l){r[n]["ADD_THOUSANDS"]=i;break}}a.cache[o]=r;form.render()});form.on("select(TENTHOUSAND)",function(t){var r=t.value;var l=a.cache[o];var i=e(t.elem).attr("uuid");for(var n=0;n<l.length;n++){if(l[n]._UUID==i){l[n].TENTHOUSAND=r;break}}e(t.elem).attr("value",r);a.cache[o]=l;form.render()});form.on("select(YAXIS)",function(t){var r=t.value;var l=a.cache[o];var i=e(t.elem).attr("uuid");for(var n=0;n<l.length;n++){if(l[n]._UUID==i){l[n].YAXIS=r;break}}e(t.elem).attr("value",r);a.cache[o]=l;form.render()});initFiledData();tableTrClick()})});function addClickData(e){debugger;layui.use(["jquery","table","layer"],function(){var a=layui.$,t=layui.table;var r=t.cache[layTableId];var l=e.FIELD_NAME;var i=e.FIELD_NAMECN;var n=e.DIMENSION;var o=e.FIELD_DECLENGTH;var d=e.ADD_THOUSANDS;var c=e.TENTHOUSAND;var u=e.YAXIS;var f=e.INDEX;var D=e.UUID;if(!D)D=generateUUID();for(var s=0;s<r.length;s++){if(r[s].FIELD_NAME==l){alert("【"+l+"】字段已经存在,请勿重复添加!");return false}}var v={FIELD_NAME:l,FIELD_NAMECN:i,DIMENSION:n,ADD_THOUSANDS:d,TENTHOUSAND:c,FIELD_DECLENGTH:o,YAXIS:u,INDEX:f,UUID:D};r.push(v);tableIns2.reload({data:r})})}function initFiledData(){debugger;var e=selectCols;if(e&&e.length>0){var a=getTableData(e);for(let e=0;e<a.length;e++){if(!a[e]._UUID){a[e]["_UUID"]=generateUUID()}}tableIns2.reload({data:a})}}function getRightTableData(){debugger;return getTableData(sourceCols)}function getTableData(e){var a=[];if(e&&e.length>0&&e[0].id&&e[0].label&&e[0].prop){a=formatOldData(e)}else{for(let i=0;i<e.length;i++){var t=e[i];var r=formatObj(t);a.push(r);if(t.children&&t.children.length>0){var l=[];parseChildrenData(t.children,l);a=a.concat(l)}}}return a}function parseChildrenData(e,a){var t=[];for(let t=0;t<e.length;t++){var r=e[t];var l=formatObj(r);a.push(l);if(r.children&&r.children.length>0){parseChildrenData(r.children,a)}}}function formatOldData(e){var a=e.map(e=>{var a={};a["FIELD_NAME"]=e.id;a["FIELD_NAMECN"]=e.label;a["DIMENSION"]=e.DIMENSION;a["INDEX"]=e.INDEX;return a});return a}function formatObj(e){var a={};for(var t in e){switch(t){case"FIELD_NAME":a.FIELD_NAME=e[t];break;case"FIELD_NAMECN":a.FIELD_NAMECN=e[t];break;case"DIMENSION":a.DIMENSION=e[t];break;case"INDEX":a.INDEX=e[t];break;case"TENTHOUSAND":a.INDEX=e[t];break;case"ADD_THOUSANDS":a.INDEX=e[t];break;case"FIELD_DECLENGTH":a.INDEX=e[t];break;case"YAXIS":a.INDEX=e[t];break}}return a}function addDimClass(){$("#right_Table .layui-table tbody tr").addClass("drag");$(".layui-table-box,.layui-table-body,.layui-table-body .layui-table").css("position","static");$(".drag").draggable({cursor:"pointer",scroll:false,helper:"clone"})}function showTableStyle(){$("#left_Table").find("td").each(function(){$("#left_Table td .layui-form-select").each(function(){$(this).parent().css("overflow","visible")})})}function addBusClass(){$("#left_Table .layui-table-body").addClass("drop");$(".drop").droppable({drop:function(e,a){layui.use(["jquery","table","layer"],function(){var e=layui.$,t=layui.table;var r=t.cache[layTableId];var l=a.helper[0].children[1].innerText;var i=a.helper[0].children[2].innerText;var n=a.helper[0].children[3].innerText;var o="";for(var d=0;d<r.length;d++){if(r[d].FIELD_NAME==l){alert("【"+l+"】字段已经存在,请勿重复拖拽!");return false}}var c={FIELD_NAME:l,FIELD_NAMECN:i,SHOW_WIDTH:o,_UUID:generateUUID()};r.push(c);tableIns2.reload({data:r})})}})}function getJsonData(){var e=layui.table.cache[layTableId];return JSON.stringify(e)}function findColItemByFieldName(e,a){for(let t=0;t<e.length;t++){if(e[t].prop===a)return e[t];else if(e[t].children&&e[t].children.length>0){return findColItemByFieldName(e[t].children,a)}}}function getSaveData(){return layui.table.cache[layTableId]}var saveflag=true;function save(){debugger;var e=getSaveData();var a=checkSaveData(e);if(a=="pieDMOverLimit"){alert("饼图不支持选择复数的维度或度量");return}if(!a){alert("判断要保存的数据是否存在重复排序或未输入排序");return}if(saveflag){saveflag=false;var t=new Loading;t.init({target:document.body});t.start();setTimeout(function(){try{if(e&&e.length>0){if(parent.temporary.echarsCtrlDM){delete parent.temporary.echarsCtrlDM[ctrlId]}parent.callBackSelectPieField(e,ctrlId);close_()}else{alert("请至少选择一列!")}}catch(e){parent.alert("操作失败!");console.log(e)}saveflag=true;t.stop()},10)}}function checkSaveData(e){debugger;var a=[];var t=[];var r=parent.$DS.getCtrlType(ctrlId);for(let l=0;l<e.length;l++){if(e[l].DIMENSION=="DIMENSION"){if(a.indexOf(e[l].INDEX)===-1){a.push(e[l].INDEX)}else{return false}}if(e[l].DIMENSION=="MEASURE"){if(t.indexOf(e[l].INDEX)===-1){t.push(e[l].INDEX)}else{return false}}if(r=="pie"){if(a.length>1||t.length>1){return"pieDMOverLimit"}}}return true}function getSelectModel(e,a,t,r){debugger;var l="";var i="";for(var n=0;n<e.length;n++){i+=YCDCommon.temp("model_option",{text:e[n].name,value:e[n].value,checked:t[a]==e[n].value?"selected":""})}l=YCDCommon.temp("model_select",{name:a,uuid:t._UUID,option:i,value:t[a],layFilter:a});return l}