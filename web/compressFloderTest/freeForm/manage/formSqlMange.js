var ptype="add";var data_sql;var tableIns2;var JsTextInfoArr={};var FORMID=YCDCommon.Win.getUrlParam("FORMID");var PID=YCDCommon.Win.getUrlParam("PID");var basepath=YCDCommon.Win.getUrlParam("basepath");var table;var layTableId="layTable";$(document).ready(function(){var e=new Array;YCDComponents.toolbar.formToolbar("main1",e);layui.use(["jquery","table","layer"],function(){var e=layui.$,a=layui.table;form=layui.form;layer=layui.layer;var r=e("#left_Table").width();var t=getFormSqls();showdata2=[];for(var l=0;l<t.length;l++){var n=t[l];if(n){var i={numbers:l,ISON:"",SQLTYPE:n.SQLTYPE,ITEMCODE:n.ITEMCODE,ITEMNAME:n.ITEMNAME,DBTYPE:n.DBTYPE,GUID:n.GUID,_UUID:n.GUID};showdata2.push(i)}}var o="layTable";tableIns2=a.render({elem:"#leftTable",id:o,data:showdata2,height:"full-41",title:"",toolbar:"#jsonToolbar",defaultToolbar:["filter",{title:"提示",layEvent:"LAYTABLE_TIPS",icon:"layui-icon-tips"}],page:false,limit:1e21,cols:[[{type:"checkbox",width:.05*r-12},{type:"numbers",title:"序号",width:.05*r},{field:"ITEMCODE",title:"SQL编码",width:.2*r,align:"center",edit:"text"},{field:"ITEMNAME",title:"SQL描述",width:.2*r,align:"center",edit:"text"},{field:"SQLTYPE ",title:"SQL类型",align:"center",width:.15*r,templet:function(e){debugger;var a=[{name:"查询",value:"QUERY"},{name:"更新",value:"UPDATE"},{name:"定义表",value:"DDL"}];var r=getSelectModel(a,"SQLTYPE",e);return r}},{field:"DBTYPE ",title:"来源数据库",align:"center",width:.15*r,templet:function(e){debugger;var a=[{name:"门户",value:"PORTAL"},{name:"本地",value:"LOCAL"}];var r=getSelectModel(a,"DBTYPE",e);return r}},{field:"GUID",title:"GUID",hide:true},{field:"ISON",title:"操作",width:.2*r-1,align:"center",templet:"#collection"},{field:"_UUID",title:"UUID",hide:true}]],done:function(e,a,r){}});a.on("toolbar(leftTable)",function(e){var r=a.checkStatus(e.config.id);switch(e.event){case"insertData":var t=a.cache[o];var l={numbers:t.length,ISON:"",ITEMCODE:"",ITEMNAME:"",SQLTYPE:"QUERY",DBTYPE:"LOCAL",GUID:"",_UUID:generateUUID()};t.push(l);tableIns2.reload({data:t});break;case"delData":var t=a.cache[o];var n=r.data;e:for(var i=t.length-1,s;i>=0;i--){for(j=0;j<n.length;j++){if(t[i]._UUID==n[j]._UUID){t.splice(i,1);continue e}}}tableIns2.reload({data:t});break;case"toTop":var t=a.cache[o];var n=r.data;if(n.length>1){alert("只能选择一项!");return false}if(n.length==0){alert("请选择一项!");return false}var I=true;for(var i=0;i<t.length;i++){if(t[i]._UUID==n[0]._UUID){if(t[i-1]&&I){var D=null;D=t[i];t[i]=t[i-1];t[i-1]=D;I=false}}}tableIns2.reload({data:t});break;case"toBottom":var t=a.cache[o];var n=r.data;if(n.length>1){alert("只能选择一项!");return false}if(n.length==0){alert("请选择一项!");return false}var I=true;for(var i=0;i<t.length;i++){if(t[i]._UUID==n[0]._UUID){if(t[i+1]&&I){var D=null;D=t[i];t[i]=t[i+1];t[i+1]=D;I=false}}}tableIns2.reload({data:t});break;case"getJson":n=getJsonData();if(n||n.length==0)alert(n);break}loadTableFilter()});a.on("edit(leftTable)",function(e){});form.on("select(SQLTYPE)",function(r){debugger;var t=r.value;var l=a.cache[o];var n=e(r.elem).attr("uuid");for(var i=0;i<l.length;i++){if(l[i]._UUID==n){l[i].SQLTYPE=t;break}}e(r.elem).attr("value",t);a.cache[o]=l;form.render()});form.on("select(DBTYPE)",function(r){debugger;var t=r.value;var l=a.cache[o];var n=e(r.elem).attr("uuid");for(var i=0;i<l.length;i++){if(l[i]._UUID==n){l[i].DBTYPE=t;break}}e(r.elem).attr("value",t);a.cache[o]=l;form.render()});tableTrClick();loadTableFilter()});initSqlParam()});function getFormSqls(){debugger;var e=[];var a=["GUID","ITEMCODE","ITEMNAME","SQLBODY","SQLTYPE","DBTYPE"];var r={filter1:"AND FORMID='"+FORMID+"'"};var t=`${basepath}/sysconfig/frame/getTableData`;var l={tableName:"DM_FORM_SQLS",columns:a.join(","),keyField:"GUID",filter:encodeURI(JSON.stringify(r)),order:"",customcolumns:""};var n=parent.selectAllTableData(parent.VUECFG.appId,"DM_FORM_SQLS",a,"GUID",r);if(!n){alert("查询页面预定义sql异常");return false}else{e=n.result.rows}return e}var guid_sql="";function editFormSqlNew(e){debugger;var a=saveFormSql(e,true);if(!a)return false;var r=$(e).attr("uuid");var t=null;var l=layui.table.cache[layTableId];for(var n=0;n<l.length;n++){if(l[n].GUID==r){t=l[n]}}guid_sql=t.GUID;var i=basepath;window.open(encodeURI(getProjectName()+"/freeForm/js/editor/online_editor/jsEditor.jsp?GUID="+t.GUID+"&type=SQL&ITEMCODE="+t.ITEMCODE+"&ITEMNAME="+t.ITEMNAME+"&appPath="+i),`formSql${t.GUID}`)}function editFormSql(e){var a=saveFormSql(e,true);if(!a)return false;var r=$(e).attr("uuid");var t=null;var l=layui.table.cache[layTableId];for(var n=0;n<l.length;n++){if(l[n].GUID==r){t=l[n]}}var i=basepath;window.open(encodeURI(i+"/freeForm/js/editor/online_editor/jsEditor.jsp?GUID="+t.GUID+"&type=SQL&ITEMCODE="+t.ITEMCODE+"&ITEMNAME="+t.ITEMNAME+"&appPath="+i),`formSql${t.GUID}`)}var saveFlag=true;function saveFormSql(e,a){debugger;saveFlag=false;var r=$(e).attr("uuid");var t=null;var l=layui.table.cache[layTableId];var n={};for(var i=0;i<l.length;i++){n[l[i].ITEMCODE]=n[l[i].ITEMCODE]?n[l[i].ITEMCODE]+1:1;if(l[i]._UUID==r){t=l[i]}}if(!t){alert("请先保存!");return false}if(n[t.ITEMCODE]>1){alert("编码不能重复!");return false}if(!t.ITEMCODE){alert("编码不能为空");return false}var o=new Date;var s=t.GUID?"edit":"add";var I={DBTYPE:t.DBTYPE,ITEMNAME:t.ITEMNAME,ITEMCODE:t.ITEMCODE,SQLTYPE:t.SQLTYPE,GUID:t.GUID,FORMID:FORMID};if(s=="add"){I.YEAR=o.getFullYear()}var D=parent.$DS.saveTable(parent.VUECFG.appId,s,I,"DM_FORM_SQLS","GUID");if(!D||D.isError){alert(D.errMsg);return false}var d=getFormSqls();var u=[];for(var E=0;E<d.length;E++){u.push({numbers:E,ISON:"",ITEMCODE:d[E].ITEMCODE,ITEMNAME:d[E].ITEMNAME,SQLTYPE:d[E].SQLTYPE,DBTYPE:d[E].DBTYPE,GUID:d[E].GUID,_UUID:d[E].GUID});JsTextInfoArr[d[E].GUID]=d[E]}tableIns2.reload({data:u});if(!a){saveFlag=true;alert("保存成功!")}loadTableFilter();return true}function delFormSql(e){var a=$(e).attr("uuid");var r=null;var t=layui.table.cache[layTableId];for(var l=0;l<t.length;l++){if(t[l]._UUID==a){r=t[l]}}layer.confirm("正在删除预定义SQL【"+r.ITEMNAME+"】,</br>是否继续?",{icon:3,title:"提示"},function(e){var a=`${basepath}/sysconfig/frame/deleteById`;var t={tableName:"DM_FORM_SQLS",keyField:"GUID",keyId:r.GUID,delRel:"",dbSource:""};var l=YCDCommon.Ajax.syncAjax(a,t);if(!l||l.isError){alert(l.errMsg);return false}var n=getFormSqls();var i=[];for(var o=0;o<n.length;o++){i.push({numbers:o,ITEMCODE:n[o].ITEMCODE,ITEMNAME:n[o].ITEMNAME,SQLTYPE:n[o].SQLTYPE,GUID:n[o].GUID,_UUID:n[o].GUID,DBTYPE:n[o].DBTYPE});JsTextInfoArr[n[o].GUID]=n[o]}tableIns2.reload({data:i});layer.close(e);alert("删除成功!");loadTableFilter()},function(e){return})}var initArr={add:false,edit:false,dalete:false};function getJsonData(){var e=layui.table.cache[layTableId];if(!e)return"";var a=[];var r=[];for(var t=0;t<e.length;t++){a.push(e[t].GUID);r.push(e[t].ITEMCODE)}showData=r.join(",");return a.join(",")}function loadTableFilter(){var e=layui.tableFilter;var a=e.render({elem:"#leftTable",mode:"local",filters:[{field:"ITEMCODE",name:"文本编码",type:"input"},{field:"ITEMNAME",name:"文本名称",type:"input"}],done:function(e){}})}function getSelectModel(e,a,r){var t="";var l="";for(var n=0;n<e.length;n++){l+=YCDCommon.temp("model_option",{text:e[n].name,value:e[n].value,checked:r[a]==e[n].value?"selected":""})}t=YCDCommon.temp("model_select",{name:a,uuid:r._UUID,option:l,value:r[a],layFilter:a});return t}function getJsValueByGuid(e){debugger;var a={};a={columns:"GUID,SQLBODY",tableName:"DM_FORM_SQLS",filter:`AND GUID='${e}'`};var r=YCDCommon.Ajax.syncAjax(basepath+"/sysconfig/frame/selectFormInfo",a);if(r.isError){alert(r.errMsg);return false}else{data_sql=r.result}if(data_sql&&data_sql["SQLBODY"]){ptype="edit";var t=data_sql["SQLBODY"]?data_sql["SQLBODY"]:"";if(t&&t!=""){js_editor.setValue(t)}else{js_editor.setValue("")}}else{js_editor.setValue("")}}function save_js(){debugger;var e=js_editor.getValue();var a={SQLBODY:e};if(ptype=="edit"){a["GUID"]=guid_sql}var r={type:ptype,keyField:"GUID",tableName:"DM_FORM_SQLS",isRefOrderNum:"1",datas:JSON.stringify(a)};var t=YCDCommon.Ajax.syncAjax(basepath+"/sysconfig/frame/saveForm",r);if(!t){alert("保存失败!")}else if(t&&t.isError){alert(t.errMsg);return false}else{data_sql=t.result.rowObj;ptype="edit";alert("保存成功!")}}function disParamDiv(){debugger;var e=document.getElementById("param_div").style.display;if(e=="none"||e=="")document.getElementById("param_div").style.display="block";else document.getElementById("param_div").style.display="none"}function initSqlParam(){var e=["$USERID$, 用户ID","$USERNAME$, 用户姓名","$FINYEAR$, 预算年度","$DISTRICTID$, 用户所在区划ID","$DISTRICTCODE$, 用户所在区划编码","$DISTRICTNAME$, 用户所在区划名称","$DIVID$, 用户所在单位ID","$DIVNAME$ ,用户所在单位名称","$UPDIVID$, 用户提升级次单位ID","$UPDIVNAME$, 用户提升级次单位名称","$DEPTID$, 用户所在处室ID","$DEPTNAME$, 用户所在处室名称","$CURRENTDATE$, 当前日期","$INITSYSDATE$, 系统日期","$USERTYPE$, 用户类型","$GUID$, 新GUID","$USERDIVLEVEL$, 用户行政级别","$CURRENTYEAR$, 当前年度","$DEPTPRIORITY$, 特殊处室","$ADMDIVLEVEL$, 用户所属级次"];for(let a of e){let e=`<li>${a}</li>`;$("#param_div").append(e)}}