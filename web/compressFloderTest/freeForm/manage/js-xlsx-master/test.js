var X;var X;var XLSX=require("./");var modp="./";var fs=require("fs"),assert=require("assert");describe("source",function(){it("should load",function(){X=require(modp)})});var opts={cellNF:true};if(process.env.WTF){opts.WTF=true;opts.cellStyles=true}var fullex=[".xlsb",".xlsm",".xlsx"];var ex=fullex.slice();ex.push(".ods");ex.push(".xls");ex.push("xml");if(process.env.FMTS==="full")process.env.FMTS=ex.join(":");if(process.env.FMTS)ex=process.env.FMTS.split(":").map(function(e){return e[0]==="."?e:"."+e});var exp=ex.map(function(e){return e+".pending"});function test_file(e){return ex.indexOf(e.substr(-5))>=0||exp.indexOf(e.substr(-13))>=0||ex.indexOf(e.substr(-4))>=0||exp.indexOf(e.substr(-12))>=0}var files=(fs.existsSync("tests.lst")?fs.readFileSync("tests.lst","utf-8").split("\n"):fs.readdirSync("test_files")).filter(test_file);var fileA=(fs.existsSync("testA.lst")?fs.readFileSync("testA.lst","utf-8").split("\n"):[]).filter(test_file);function fixsheetname(e){return e.substr(0,31)}function stripbom(e){return e.replace(/^\ufeff/,"")}function fixcsv(e){return stripbom(e).replace(/\t/g,",").replace(/#{255}/g,"").replace(/"/g,"").replace(/[\n\r]+/g,"\n").replace(/\n*$/,"")}function fixjson(e){return e.replace(/[\r\n]+$/,"")}var dir="./test_files/";var paths={cpxls:dir+"custom_properties.xls",cpxml:dir+"custom_properties.xls.xml",cpxlsx:dir+"custom_properties.xlsx",cpxlsb:dir+"custom_properties.xlsb",cssxls:dir+"cell_style_simple.xls",cssxml:dir+"cell_style_simple.xml",cssxlsx:dir+"cell_style_simple.xlsx",cssxlsb:dir+"cell_style_simple.xlsb",cstxls:dir+"comments_stress_test.xls",cstxml:dir+"comments_stress_test.xls.xml",cstxlsx:dir+"comments_stress_test.xlsx",cstxlsb:dir+"comments_stress_test.xlsb",fstxls:dir+"formula_stress_test.xls",fstxml:dir+"formula_stress_test.xls.xml",fstxlsx:dir+"formula_stress_test.xlsx",fstxlsb:dir+"formula_stress_test.xlsb",fstods:dir+"formula_stress_test.ods",hlxls:dir+"hyperlink_stress_test_2011.xls",hlxml:dir+"hyperlink_stress_test_2011.xml",hlxlsx:dir+"hyperlink_stress_test_2011.xlsx",hlxlsb:dir+"hyperlink_stress_test_2011.xlsb",lonxls:dir+"LONumbers.xls",lonxlsx:dir+"LONumbers.xlsx",mcxls:dir+"merge_cells.xls",mcxml:dir+"merge_cells.xls.xml",mcxlsx:dir+"merge_cells.xlsx",mcxlsb:dir+"merge_cells.xlsb",mcods:dir+"merge_cells.ods",nfxls:dir+"number_format.xls",nfxml:dir+"number_format.xls.xml",nfxlsx:dir+"number_format.xlsm",nfxlsb:dir+"number_format.xlsb",dtxlsx:dir+"xlsx-stream-d-date-cell.xlsx",dtxlsb:dir+"xlsx-stream-d-date-cell.xlsb",swcxls:dir+"apachepoi_SimpleWithComments.xls",swcxml:dir+"2011/apachepoi_SimpleWithComments.xls.xml",swcxlsx:dir+"apachepoi_SimpleWithComments.xlsx",swcxlsb:dir+"2013/apachepoi_SimpleWithComments.xlsx.xlsb"};var N1="XLSX";var N2="XLSB";var N3="XLS";var N4="XML";function parsetest(e,t,s,r){r=r?" ["+r+"]":"";if(!s&&r)return;describe(e+r+" should have all bits",function(){var s=dir+"2011/"+e.substr(e.lastIndexOf("/")+1)+".sheetnames";it("should have all sheets",function(){t.SheetNames.forEach(function(e){assert(t.Sheets[e],"bad sheet "+e)})});it("should have the right sheet names",fs.existsSync(s)?function(){var e=fs.readFileSync(s,"utf-8").replace(/\r/g,"");var r=t.SheetNames.map(fixsheetname).join("\n")+"\n";assert.equal(r,e)}:null)});describe(e+r+" should generate CSV",function(){t.SheetNames.forEach(function(e,s){it("#"+s+" ("+e+")",function(){X.utils.make_csv(t.Sheets[e])})})});describe(e+r+" should generate JSON",function(){t.SheetNames.forEach(function(e,s){it("#"+s+" ("+e+")",function(){X.utils.sheet_to_row_object_array(t.Sheets[e])})})});describe(e+r+" should generate formulae",function(){t.SheetNames.forEach(function(e,s){it("#"+s+" ("+e+")",function(){X.utils.get_formulae(t.Sheets[e])})})});if(!s)return;var a=function(e,t,s,r){var a=e+t+"."+s+r;if(t.substr(-5)===".xlsb"){root=t.slice(0,-5);if(!fs.existsSync(a))a=e+root+".xlsx."+s+r;if(!fs.existsSync(a))a=e+root+".xlsm."+s+r;if(!fs.existsSync(a))a=e+root+".xls."+s+r}if(t.substr(-4)===".xls"){root=t.slice(0,-4);if(!fs.existsSync(a))a=e+root+".xlsx."+s+r;if(!fs.existsSync(a))a=e+root+".xlsm."+s+r;if(!fs.existsSync(a))a=e+root+".xlsb."+s+r}return a};describe(e+r+" should generate correct CSV output",function(){t.SheetNames.forEach(function(s,r){var n=a(dir,e,r,".csv");it("#"+r+" ("+s+")",fs.existsSync(n)?function(){var e=fixcsv(fs.readFileSync(n,"utf-8"));var r=fixcsv(X.utils.make_csv(t.Sheets[s]));var a=e==r;if(!a){var i=X.readFile(t.FILENAME,{cellStyles:true,cellNF:true});var o=fixcsv(X.utils.make_csv(i.Sheets[s]));var l=e==o;var f=XLSX.read(XLSX.write(i,{type:"buffer",bookType:"xlsx"}),{cellStyles:true,cellNF:true});var u=fixcsv(XLSX.utils.make_csv(f.Sheets[s]));var c=e==u;console.error("CSV Diff: "+[t.FILENAME,r.length,e.length,a,l,c])}assert.equal(a||c,true,"CSV badness")}:null)})});describe(e+r+" should generate correct JSON output",function(){t.SheetNames.forEach(function(s,r){var n=a(dir,e,r,".rawjson");if(fs.existsSync(n))it("#"+r+" ("+s+")",function(){var e=fs.readFileSync(n,"utf-8");var r=X.utils.make_json(t.Sheets[s],{raw:true});assert.equal(JSON.stringify(r),fixjson(e),"JSON badness")});var i=a(dir,e,r,".json");if(fs.existsSync(i))it("#"+r+" ("+s+")",function(){var e=fs.readFileSync(i,"utf-8");var r=X.utils.make_json(t.Sheets[s]);assert.equal(JSON.stringify(r),fixjson(e),"JSON badness")})})});if(fs.existsSync(dir+"2011/"+e+".xml"))describe(e+r+".xml from 2011",function(){it("should parse",function(){var t=X.readFile(dir+"2011/"+e+".xml",opts)})});if(fs.existsSync(dir+"2013/"+e+".xlsb"))describe(e+r+".xlsb from 2013",function(){it("should parse",function(){var t=X.readFile(dir+"2013/"+e+".xlsb",opts)})});if(fs.existsSync(dir+e+".xml"+r))describe(e+".xml",function(){it("should parse",function(){var t=X.readFile(dir+e+".xml",opts)})})}var wbtable={};describe("should parse test files",function(){files.forEach(function(e){if(!fs.existsSync(dir+e))return;it(e,e.substr(-8)==".pending"?null:function(){var t=X.readFile(dir+e,opts);wbtable[dir+e]=t;parsetest(e,t,true)});fullex.forEach(function(t,s){it(e+" ["+t+"]",function(){var s=wbtable[dir+e];if(!s)s=X.readFile(dir+e,opts);var r=s.FILENAME;s=X.read(X.write(s,{type:"buffer",bookType:t.replace(/\./,"")}),{WTF:opts.WTF,cellNF:true});s.FILENAME=r;parsetest(e,s,t.replace(/\./,"")!=="xlsb",t)})})});fileA.forEach(function(e){if(!fs.existsSync(dir+e))return;it(e,e.substr(-8)==".pending"?null:function(){var t=X.readFile(dir+e,{WTF:opts.wtf,sheetRows:10});parsetest(e,t,false)})})});describe("parse options",function(){var e=["s"];before(function(){X=require(modp)});describe("cell",function(){it("XLSX should generate HTML by default",function(){var t=X.readFile(paths.cstxlsx);var s=t.Sheets.Sheet1;Object.keys(s).forEach(function(t){if(t[0]==="!"||!s.hasOwnProperty(t))return;assert(e.indexOf(s[t].t)===-1||s[t].h)})});it("XLSX should not generate HTML when requested",function(){var e=X.readFile(paths.cstxlsx,{cellHTML:false});var t=e.Sheets.Sheet1;Object.keys(t).forEach(function(e){if(e[0]==="!"||!t.hasOwnProperty(e))return;assert(typeof t[e].h==="undefined")})});it("should generate formulae by default",function(){[paths.fstxls,paths.fstxlsb].forEach(function(e){var t=X.readFile(e);var s=false;t.SheetNames.forEach(function(e){var r=t.Sheets[e];Object.keys(r).forEach(function(e){if(e[0]==="!"||!r.hasOwnProperty(e))return;if(typeof r[e].f!=="undefined")return s=true})});assert(s)})});it("should not generate formulae when requested",function(){[paths.fstxls,paths.fstxlsb].forEach(function(e){var t=X.readFile(e,{cellFormula:false});t.SheetNames.forEach(function(e){var s=t.Sheets[e];Object.keys(s).forEach(function(e){if(e[0]==="!"||!s.hasOwnProperty(e))return;assert(typeof s[e].f==="undefined")})})})});it("should not generate number formats by default",function(){[paths.nfxls,paths.nfxlsx].forEach(function(e){var t=X.readFile(e);t.SheetNames.forEach(function(e){var s=t.Sheets[e];Object.keys(s).forEach(function(e){if(e[0]==="!"||!s.hasOwnProperty(e))return;assert(typeof s[e].z==="undefined")})})})});it("should generate number formats when requested",function(){[paths.nfxls,paths.nfxlsx].forEach(function(e){var t=X.readFile(e,{cellNF:true});t.SheetNames.forEach(function(e){var s=t.Sheets[e];Object.keys(s).forEach(function(e){if(e[0]==="!"||!s.hasOwnProperty(e))return;assert(s[e].t!=="n"||typeof s[e].z!=="undefined")})})})});it("should not generate cell styles by default",function(){[paths.cssxlsx,paths.cssxls,paths.cssxml].forEach(function(e){var t=X.readFile(e);t.SheetNames.forEach(function(e){var s=t.Sheets[e];Object.keys(s).forEach(function(e){if(e[0]==="!"||!s.hasOwnProperty(e))return;assert(typeof s[e].s==="undefined")})})})});it("should generate cell styles when requested",function(){[paths.cssxlsx].forEach(function(e){var t=X.readFile(e,{cellStyles:true});var s=false;t.SheetNames.forEach(function(e){var r=t.Sheets[e];Object.keys(r).forEach(function(e){if(e[0]==="!"||!r.hasOwnProperty(e))return;if(typeof r[e].s!=="undefined")return s=true})});assert(s)})});it("should not generate cell dates by default",function(){var e=X.readFile(paths.dtxlsx);e.SheetNames.forEach(function(t){var s=e.Sheets[t];Object.keys(s).forEach(function(e){if(e[0]==="!"||!s.hasOwnProperty(e))return;assert(s[e].t!=="d")})})});it("XLSB should not generate cell dates",function(){var e=X.readFile(paths.dtxlsb,{cellDates:true});e.SheetNames.forEach(function(t){var s=e.Sheets[t];Object.keys(s).forEach(function(e){if(e[0]==="!"||!s.hasOwnProperty(e))return;assert(s[e].t!=="d")})})});it("XLSX should generate cell dates when requested",function(){var e=X.readFile(paths.dtxlsx,{cellDates:true});var t=false;e.SheetNames.forEach(function(s){var r=e.Sheets[s];Object.keys(r).forEach(function(e){if(e[0]==="!"||!r.hasOwnProperty(e))return;if(r[e].t==="d")return t=true})});assert(t)})});describe("sheet",function(){it("should not generate sheet stubs by default",function(){[paths.mcxlsx,paths.mcxlsb,paths.mcods,paths.mcxls,paths.mcxml].forEach(function(e){var t=X.readFile(e);assert.throws(function(){return t.Sheets.Merge.A2.v})})});it("should generate sheet stubs when requested",function(){[paths.mcxlsx,paths.mcxlsb].forEach(function(e){var t=X.readFile(e,{sheetStubs:true});assert(typeof t.Sheets.Merge.A2.t!=="undefined")})});function e(e,t,s,r,a){assert(typeof e.Sheets.Text.A46!=="undefined"==t);assert(typeof e.Sheets.Text.B26!=="undefined"==s);assert(typeof e.Sheets.Text.C16!=="undefined"==r);assert(typeof e.Sheets.Text.D2!=="undefined"==a)}it("should read all cells by default",function(){[paths.fstxlsx,paths.fstxlsb,paths.fstods,paths.fstxls,paths.fstxml].forEach(function(t){e(X.readFile(t),true,true,true,true)})});it("sheetRows n=20",function(){[paths.fstxlsx,paths.fstxlsb,paths.fstods,paths.fstxls,paths.fstxml].forEach(function(t){e(X.readFile(t,{sheetRows:20}),false,false,true,true)})});it("sheetRows n=10",function(){[paths.fstxlsx,paths.fstxlsb,paths.fstods,paths.fstxls,paths.fstxml].forEach(function(t){e(X.readFile(t,{sheetRows:10}),false,false,false,true)})})});describe("book",function(){it("bookSheets should not generate sheets",function(){[paths.mcxlsx,paths.mcxlsb,paths.mcxls,paths.mcxml].forEach(function(e){var t=X.readFile(e,{bookSheets:true});assert(typeof t.Sheets==="undefined")})});it("bookProps should not generate sheets",function(){[paths.nfxlsx,paths.nfxlsb,paths.nfxls,paths.nfxml].forEach(function(e){var t=X.readFile(e,{bookProps:true});assert(typeof t.Sheets==="undefined")})});it("bookProps && bookSheets should not generate sheets",function(){[paths.lonxlsx,paths.lonxls].forEach(function(e){var t=X.readFile(e,{bookProps:true,bookSheets:true});assert(typeof t.Sheets==="undefined")})});it("should not generate deps by default",function(){[paths.fstxlsx,paths.fstxlsb,paths.fstxls,paths.fstxml].forEach(function(e){var t=X.readFile(e);assert(typeof t.Deps==="undefined"||!(t.Deps&&t.Deps.length>0))})});it("bookDeps should generate deps (XLSX/XLSB)",function(){[paths.fstxlsx,paths.fstxlsb].forEach(function(e){var t=X.readFile(e,{bookDeps:true});assert(typeof t.Deps!=="undefined"&&t.Deps.length>0)})});var e=function(e,t,s){t.forEach(function(t){assert(typeof e[t]!=="undefined"==s)})};it("should not generate book files by default",function(){var t;t=X.readFile(paths.fstxlsx);e(t,["files","keys"],false);t=X.readFile(paths.fstxlsb);e(t,["files","keys"],false);t=X.readFile(paths.fstxls);e(t,["cfb"],false)});it("bookFiles should generate book files",function(){var t;t=X.readFile(paths.fstxlsx,{bookFiles:true});e(t,["files","keys"],true);t=X.readFile(paths.fstxlsb,{bookFiles:true});e(t,["files","keys"],true);t=X.readFile(paths.fstxls,{bookFiles:true});e(t,["cfb"],true)});it("should not generate VBA by default",function(){var e=X.readFile(paths.nfxlsx);assert(typeof e.vbaraw==="undefined");e=X.readFile(paths.nfxlsb);assert(typeof e.vbaraw==="undefined")});it("bookVBA should generate vbaraw (XLSX/XLSB)",function(){var e=X.readFile(paths.nfxlsx,{bookVBA:true});assert(typeof e.vbaraw!=="undefined");e=X.readFile(paths.nfxlsb,{bookVBA:true});assert(typeof e.vbaraw!=="undefined")})})});describe("input formats",function(){it("should read binary strings",function(){X.read(fs.readFileSync(paths.cstxlsx,"binary"),{type:"binary"});X.read(fs.readFileSync(paths.cstxlsb,"binary"),{type:"binary"});X.read(fs.readFileSync(paths.cstxls,"binary"),{type:"binary"});X.read(fs.readFileSync(paths.cstxml,"binary"),{type:"binary"})});it("should read base64 strings",function(){X.read(fs.readFileSync(paths.cstxls,"base64"),{type:"base64"});X.read(fs.readFileSync(paths.cstxml,"base64"),{type:"base64"});X.read(fs.readFileSync(paths.cstxlsx,"base64"),{type:"base64"});X.read(fs.readFileSync(paths.cstxlsb,"base64"),{type:"base64"})});it("should read buffers",function(){X.read(fs.readFileSync(paths.cstxls),{type:"buffer"});X.read(fs.readFileSync(paths.cstxml),{type:"buffer"});X.read(fs.readFileSync(paths.cstxlsx),{type:"buffer"});X.read(fs.readFileSync(paths.cstxlsb),{type:"buffer"})});it("should read array",function(){X.read(fs.readFileSync(paths.mcxls,"binary").split("").map(function(e){return e.charCodeAt(0)}),{type:"array"});X.read(fs.readFileSync(paths.mcxml,"binary").split("").map(function(e){return e.charCodeAt(0)}),{type:"array"});X.read(fs.readFileSync(paths.mcxlsx,"binary").split("").map(function(e){return e.charCodeAt(0)}),{type:"array"});X.read(fs.readFileSync(paths.mcxlsb,"binary").split("").map(function(e){return e.charCodeAt(0)}),{type:"array"});X.read(fs.readFileSync(paths.mcods,"binary").split("").map(function(e){return e.charCodeAt(0)}),{type:"array"})});it("should throw if format is unknown",function(){assert.throws(function(){X.read(fs.readFileSync(paths.cstxls),{type:"dafuq"})});assert.throws(function(){X.read(fs.readFileSync(paths.cstxml),{type:"dafuq"})});assert.throws(function(){X.read(fs.readFileSync(paths.cstxlsx),{type:"dafuq"})});assert.throws(function(){X.read(fs.readFileSync(paths.cstxlsb),{type:"dafuq"})})});it("should infer buffer type",function(){X.read(fs.readFileSync(paths.cstxls));X.read(fs.readFileSync(paths.cstxml));X.read(fs.readFileSync(paths.cstxlsx));X.read(fs.readFileSync(paths.cstxlsb))});it("should default to base64 type",function(){assert.throws(function(){X.read(fs.readFileSync(paths.cstxls,"binary"))});assert.throws(function(){X.read(fs.readFileSync(paths.cstxml,"binary"))});assert.throws(function(){X.read(fs.readFileSync(paths.cstxlsx,"binary"))});assert.throws(function(){X.read(fs.readFileSync(paths.cstxlsb,"binary"))});X.read(fs.readFileSync(paths.cstxls,"base64"));X.read(fs.readFileSync(paths.cstxml,"base64"));X.read(fs.readFileSync(paths.cstxlsx,"base64"));X.read(fs.readFileSync(paths.cstxlsb,"base64"))})});describe("output formats",function(){var e,t,s,r;before(function(){X=require(modp);e=X.readFile(paths.cpxlsx);t=X.readFile(paths.cpxlsb);s=X.readFile(paths.cpxls);r=X.readFile(paths.cpxml)});it("should write binary strings",function(){X.write(e,{type:"binary"});X.write(t,{type:"binary"});X.write(s,{type:"binary"});X.write(r,{type:"binary"});X.read(X.write(e,{type:"binary"}),{type:"binary"});X.read(X.write(t,{type:"binary"}),{type:"binary"});X.read(X.write(s,{type:"binary"}),{type:"binary"});X.read(X.write(r,{type:"binary"}),{type:"binary"})});it("should write base64 strings",function(){X.write(e,{type:"base64"});X.write(t,{type:"base64"});X.write(s,{type:"base64"});X.write(r,{type:"base64"});X.read(X.write(e,{type:"base64"}),{type:"base64"});X.read(X.write(t,{type:"base64"}),{type:"base64"});X.read(X.write(s,{type:"base64"}),{type:"base64"});X.read(X.write(r,{type:"base64"}),{type:"base64"})});it("should write buffers",function(){X.write(e,{type:"buffer"});X.write(t,{type:"buffer"});X.write(s,{type:"buffer"});X.write(r,{type:"buffer"});X.read(X.write(e,{type:"buffer"}),{type:"buffer"});X.read(X.write(t,{type:"buffer"}),{type:"buffer"});X.read(X.write(s,{type:"buffer"}),{type:"buffer"});X.read(X.write(r,{type:"buffer"}),{type:"buffer"})});it("should throw if format is unknown",function(){assert.throws(function(){X.write(e,{type:"dafuq"})});assert.throws(function(){X.write(t,{type:"dafuq"})});assert.throws(function(){X.write(s,{type:"dafuq"})});assert.throws(function(){X.write(r,{type:"dafuq"})})})});function coreprop(e){assert.equal(e.Props.Title,"Example with properties");assert.equal(e.Props.Subject,"Test it before you code it");assert.equal(e.Props.Author,"Pony Foo");assert.equal(e.Props.Manager,"Despicable Drew");assert.equal(e.Props.Company,"Vector Inc");assert.equal(e.Props.Category,"Quirky");assert.equal(e.Props.Keywords,"example humor");assert.equal(e.Props.Comments,"some comments");assert.equal(e.Props.LastAuthor,"Hugues")}function custprop(e){assert.equal(e.Custprops["I am a boolean"],true);assert.equal(e.Custprops["Date completed"].toISOString(),"1967-03-09T16:30:00.000Z");assert.equal(e.Custprops.Status,2);assert.equal(e.Custprops.Counter,-3.14)}function cmparr(e){for(var t=1;t!=e.length;++t)assert.deepEqual(e[0],e[t])}function deepcmp(e,t,s,r,a){var n=s.indexOf(".");r=(r||"")+"|"+(n>-1?s.substr(0,n):s);if(n<0)return assert[a<0?"notEqual":"equal"](e[s],t[s],r);return deepcmp(e[s.substr(0,n)],t[s.substr(0,n)],s.substr(n+1),r,a)}var styexc=["A2|H10|bgColor.rgb","F6|H1|patternType"];var stykeys=["patternType","fgColor","bgColor"];function diffsty(e,t,s){var r=e[t].s.fill,a=e[s].s.fill;stykeys.forEach(function(e){var n=-1;if(styexc.indexOf(t+"|"+s+"|"+e)>-1)n=1;else if(styexc.indexOf(s+"|"+t+"|"+e)>-1)n=1;deepcmp(r,a,e,t+","+s,n)})}describe("parse features",function(){it("should have comment as part of cell properties",function(){var e=require(modp);var t="Sheet1";var s=e.readFile(paths.swcxlsx);var r=e.readFile(paths.swcxlsb);var a=e.readFile(paths.swcxls);var n=e.readFile(paths.swcxml);[s,r,a,n].map(function(e){return e.Sheets[t]}).forEach(function(e,t){assert.equal(e.B1.c.length,1,"must have 1 comment");assert.equal(e.B1.c[0].a,"Yegor Kozlov","must have the same author");assert.equal(e.B1.c[0].t.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),"Yegor Kozlov:\nfirst cell","must have the concatenated texts");if(t>0)return;assert.equal(e.B1.c[0].r,'<r><rPr><b/><sz val="8"/><color indexed="81"/><rFont val="Tahoma"/></rPr><t>Yegor Kozlov:</t></r><r><rPr><sz val="8"/><color indexed="81"/><rFont val="Tahoma"/></rPr><t xml:space="preserve">\r\nfirst cell</t></r>',"must have the rich text representation");assert.equal(e.B1.c[0].h,'<span style="font-weight: bold;">Yegor Kozlov:</span><span style=""><br/>first cell</span>',"must have the html representation")})});describe("should parse core properties and custom properties",function(){var e,t;before(function(){e=X.readFile(paths.cpxlsx);t=X.readFile(paths.cpxlsb);wb3=X.readFile(paths.cpxls);wb4=X.readFile(paths.cpxml)});it(N1+" should parse core properties",function(){coreprop(e)});it(N2+" should parse core properties",function(){coreprop(t)});it(N3+" should parse core properties",function(){coreprop(wb3)});it(N4+" should parse core properties",function(){coreprop(wb4)});it(N1+" should parse custom properties",function(){custprop(e)});it(N2+" should parse custom properties",function(){custprop(t)});it(N3+" should parse custom properties",function(){custprop(wb3)});it(N4+" should parse custom properties",function(){custprop(wb4)})});describe("sheetRows",function(){it("should use original range if not set",function(){var e={};var t=X.readFile(paths.fstxlsx,e);var s=X.readFile(paths.fstxlsb,e);var r=X.readFile(paths.fstxls,e);var a=X.readFile(paths.fstxml,e);[t,s,r,a].forEach(function(e){assert.equal(e.Sheets.Text["!ref"],"A1:F49")})});it("should adjust range if set",function(){var e={sheetRows:10};var t=X.readFile(paths.fstxlsx,e);var s=X.readFile(paths.fstxlsb,e);var r=X.readFile(paths.fstxls,e);var a=X.readFile(paths.fstxml,e);[t,s].forEach(function(e){assert.equal(e.Sheets.Text["!fullref"],"A1:F49");assert.equal(e.Sheets.Text["!ref"],"A1:F10")})});it("should not generate comment cells",function(){var e={sheetRows:10};var t=X.readFile(paths.cstxlsx,e);var s=X.readFile(paths.cstxlsb,e);var r=X.readFile(paths.cstxls,e);var a=X.readFile(paths.cstxml,e);[t,s].forEach(function(e){assert.equal(e.Sheets.Sheet7["!fullref"],"A1:N34");assert.equal(e.Sheets.Sheet7["!ref"],"A1")})})});describe("merge cells",function(){var e,t;before(function(){X=require(modp);e=X.readFile(paths.mcxlsx);t=X.readFile(paths.mcxlsb);wb3=X.readFile(paths.mcods);wb4=X.readFile(paths.mcxls);wb5=X.readFile(paths.mcxml)});it("should have !merges",function(){assert(e.Sheets.Merge["!merges"]);assert(t.Sheets.Merge["!merges"]);assert(wb3.Sheets.Merge["!merges"]);assert(wb4.Sheets.Merge["!merges"]);assert(wb5.Sheets.Merge["!merges"]);var s=[e,t,wb3,wb4,wb5].map(function(e){return e.Sheets.Merge["!merges"].map(function(e){return X.utils.encode_range(e)})});assert.deepEqual(s[0].sort(),s[1].sort());assert.deepEqual(s[0].sort(),s[2].sort());assert.deepEqual(s[0].sort(),s[3].sort());assert.deepEqual(s[0].sort(),s[4].sort())})});describe("should find hyperlinks",function(){var e,t;before(function(){X=require(modp);e=X.readFile(paths.hlxlsx);t=X.readFile(paths.hlxlsb);wb3=X.readFile(paths.hlxls);wb4=X.readFile(paths.hlxml)});function s(e){var t=e.Sheets.Sheet1;assert.equal(t.A1.l.Target,"http://www.sheetjs.com");assert.equal(t.A2.l.Target,"http://oss.sheetjs.com");assert.equal(t.A3.l.Target,"http://oss.sheetjs.com#foo");assert.equal(t.A4.l.Target,"mailto:dev@sheetjs.com");assert.equal(t.A5.l.Target,"mailto:dev@sheetjs.com?subject=hyperlink");assert.equal(t.A6.l.Target,"../../sheetjs/Documents/Test.xlsx");assert.equal(t.A7.l.Target,"http://sheetjs.com")}it(N1,function(){s(e)});it(N2,function(){s(t)});it(N3,function(){s(wb3)});it(N4,function(){s(wb4)})});describe("should parse cells with date type (XLSX/XLSM)",function(){it("Must have read the date",function(){var e,t;var s="Sheet1";e=X.readFile(paths.dtxlsx);t=e.Sheets[s];var r=X.utils.sheet_to_row_object_array(t);assert.equal(r[3]["てすと"],"2/14/14")});it("cellDates should not affect formatted text",function(){var e,t,s,r;var a="Sheet1";e=X.readFile(paths.dtxlsx);t=e.Sheets[a];s=X.readFile(paths.dtxlsb);r=s.Sheets[a];assert.equal(X.utils.sheet_to_csv(t),X.utils.sheet_to_csv(r))})});describe("should correctly handle styles",function(){var e,t,s,r;before(function(){e=X.readFile(paths.cssxls,{cellStyles:true,WTF:1}).Sheets.Sheet1;t=X.readFile(paths.cssxlsx,{cellStyles:true,WTF:1}).Sheets.Sheet1;s=function(e){var t=X.utils.decode_range(e);var s=[];for(var r=t.s.r;r<=t.e.r;++r)for(var a=t.s.c;a<=t.e.c;++a)s.push(X.utils.encode_cell({c:a,r:r}));return s};r=function(e){return[].concat.apply([],e.split(",").map(s))}});var a=["A1:D1,F1:G1","A2:D2,F2:G2","A3:A10","B3:B10","E1:E10","F6:F8","H1:J4","H10"];var n=[{patternType:"darkHorizontal",fgColor:{theme:9,tint:-.249977111117893,rgb_raw:"F79646",rgb:"E46C0A"},bgColor:{theme:5,tint:.3999755851924192,rgb_raw:"C0504D",rgb:"D99694"}},{patternType:"darkUp",fgColor:{theme:3,tint:-.249977111117893,rgb_raw:"EEECE1",rgb:"C4BD97"},bgColor:{theme:7,tint:.3999755851924192,rgb_raw:"8064A2",rgb:"B3A2C7"}},{patternType:"darkGray",fgColor:{theme:3,rgb_raw:"EEECE1",rgb:"EEECE1"},bgColor:{theme:1,rgb_raw:"FFFFFF",rgb:"FFFFFF"}},{patternType:"lightGray",fgColor:{theme:6,tint:.3999755851924192,rgb_raw:"9BBB59",rgb:"C3D69B"},bgColor:{theme:2,tint:-.499984740745262,rgb_raw:"1F497D",rgb:"10253F"}},{patternType:"lightDown",fgColor:{theme:4,tint:-.249977111117893,rgb_raw:"4F81BD",rgb:"376092"},bgColor:{theme:7,tint:-.249977111117893,rgb_raw:"8064A2",rgb:"604A7B"}},{patternType:"lightGrid",fgColor:{theme:6,tint:-.249977111117893,rgb_raw:"9BBB59",rgb:"77933C"},bgColor:{theme:9,tint:-.249977111117893,rgb_raw:"F79646",rgb:"E46C0A"}},{patternType:"lightGrid",fgColor:{theme:4,rgb_raw:"4F81BD",rgb:"4F81BD"},bgColor:{theme:2,tint:-.749992370372631,rgb_raw:"1F497D",rgb:"08121F"}},{patternType:"lightVertical",fgColor:{theme:3,tint:.3999755851924192,rgb_raw:"EEECE1",rgb:"F5F4ED"},bgColor:{theme:7,tint:.3999755851924192,rgb_raw:"8064A2",rgb:"B3A2C7"}}];a.forEach(function(s){it("XLS  | "+s,function(){cmparr(r(s).map(function(t){return e[t].s}))});it("XLSX | "+s,function(){cmparr(r(s).map(function(e){return t[e].s}))})});it("different styles",function(){for(var e=0;e!=a.length-1;++e){for(var s=e+1;s!=a.length;++s){diffsty(t,r(a[e])[0],r(a[s])[0])}}});it("correct styles",function(){var s=a.map(function(e){return r(e)[0]}).map(function(t){return e[t].s});var i=a.map(function(e){return r(e)[0]}).map(function(e){return t[e].s});for(var o=0;o!=n.length;++o){var l=["fgColor.theme","fgColor.rgb","bgColor.theme","bgColor.rgb","patternType"];l.forEach(function(e){deepcmp(n[o],i[o].fill,e,o+":"+e)})}})})});function seq(e,t){var s=t||0;var r=new Array(e-s);for(var a=0;a!=r.length;++a)r[a]=s+a;return r}describe("roundtrip features",function(){before(function(){X=require(modp)});describe("should parse core properties and custom properties",function(){var e,t,s="./tmp/cp";before(function(){e=X.readFile(paths.cpxlsx);t=X.readFile(paths.cpxlsb);fullex.forEach(function(r){X.writeFile(e,s+".xlsm"+r);X.writeFile(t,s+".xlsb"+r)})});fullex.forEach(function(e){[".xlsm",".xlsb"].forEach(function(t){it(t+e+" should roundtrip core and custom properties",function(){var r=X.readFile(s+t+e);coreprop(r);custprop(r)})})})});describe("should preserve features",function(){it("merge cells",function(){var e=X.readFile(paths.mcxlsx);var t=X.read(X.write(e,{type:"binary"}),{type:"binary"});var s=e.Sheets.Merge["!merges"].map(X.utils.encode_range);var r=t.Sheets.Merge["!merges"].map(X.utils.encode_range);assert.equal(s.length,r.length);for(var a=0;a<s.length;++a)assert.equal(s[a],r[a])})});describe("should preserve dates",function(){seq(16).forEach(function(e){var t=e&1?"d":"n",s=t==="d";var r=e&2?"d":"n",a=r==="d";var n=e&4?"d":"n",i=n==="d";var o=e&8?"d":"n",l=o==="d";var f,u,c;if(l){f=paths.dtxlsx;u="Sheet1";c="B5"}else{f=paths.nfxlsx;u="2011";c="J36"}it("["+o+"] -> ("+n+") -> ["+r+"] -> ("+t+")",function(){var e=X.readFile(f,{cellNF:true,cellDates:i,WTF:opts.WTF});var t=X.read(X.write(e,{type:"binary",cellDates:a,WTF:opts.WTF}),{type:"binary",cellDates:s,WTF:opts.WTF});var r=[e,t].map(function(e){return e.Sheets[u][c]});assert.equal(r[0].w,r[1].w);if(l&&i)assert.equal(r[0].t,"d");else assert.equal(r[0].t,"n");if(l&&i&&a&&s)assert.equal(r[1].t,"d");else if(a&&s&&!i);else assert.equal(r[1].t,"n");if(r[0].t===r[1].t)assert.equal(r[0].v,r[1].v);else if(r[0].t==="d")assert(Math.abs(datenum(new Date(r[0].v))-r[1].v)<.01)})})});describe("xls to xlsx conversions",function(){[["XLS","formula_stress_test.xls"],["XML","formula_stress_test.xls.xml"]].forEach(function(e){it("should be able to write "+e[0]+" files",function(){var t=X.readFile("./test_files/"+e[1],{cellNF:true});X.writeFile(t,"./tmp/"+e[1]+".xlsx",{bookSST:true});X.writeFile(t,"./tmp/"+e[1]+".xlsb",{bookSST:true})})})})});function password_file(e){return e.match(/^password.*\.xls$/)}var password_files=fs.readdirSync("test_files").filter(password_file);describe("invalid files",function(){describe("parse",function(){[["password","apachepoi_password.xls"],["passwords","apachepoi_xor-encryption-abc.xls"],["DOC files","word_doc.doc"]].forEach(function(e){it("should fail on "+e[0],function(){assert.throws(function(){X.readFile(dir+e[1])});assert.throws(function(){X.read(fs.readFileSync(dir+e[1],"base64"),{type:"base64"})})})})});describe("write",function(){it("should pass -> XLSX",function(){X.write(X.readFile(paths.fstxlsb),{type:"binary"});X.write(X.readFile(paths.fstxlsx),{type:"binary"});X.write(X.readFile(paths.fstxls),{type:"binary"});X.write(X.readFile(paths.fstxml),{type:"binary"})});it("should pass if a sheet is missing",function(){var e=X.readFile(paths.fstxlsx);delete e.Sheets[e.SheetNames[0]];X.read(X.write(e,{type:"binary"}),{type:"binary"})});["Props","Custprops","SSF"].forEach(function(e){it("should pass if "+e+" is missing",function(){var t=X.readFile(paths.fstxlsx);assert.doesNotThrow(function(){delete t[e];X.write(t,{type:"binary"})})})});["SheetNames","Sheets"].forEach(function(e){it("should fail if "+e+" is missing",function(){var t=X.readFile(paths.fstxlsx);assert.throws(function(){delete t[e];X.write(t,{type:"binary"})})})})})});function datenum(e,t){if(t)e+=1462;var s=Date.parse(e);return(s-new Date(Date.UTC(1899,11,30)))/(24*60*60*1e3)}function sheet_from_array_of_arrays(e,t){var s={};var r={s:{c:1e7,r:1e7},e:{c:0,r:0}};for(var a=0;a!=e.length;++a){for(var n=0;n!=e[a].length;++n){if(r.s.r>a)r.s.r=a;if(r.s.c>n)r.s.c=n;if(r.e.r<a)r.e.r=a;if(r.e.c<n)r.e.c=n;var i={v:e[a][n]};if(i.v==null)continue;var o=X.utils.encode_cell({c:n,r:a});if(typeof i.v==="number")i.t="n";else if(typeof i.v==="boolean")i.t="b";else if(i.v instanceof Date){i.t="n";i.z=X.SSF._table[14];i.v=datenum(i.v)}else i.t="s";s[o]=i}}if(r.s.c<1e7)s["!ref"]=X.utils.encode_range(r);return s}describe("json output",function(){function e(e,t,s){for(var r=0;r!=e.length;++r){for(var a=0;a!=t.length;++a){if(e[r][t[a]]===s)throw new Error("found "+s+" in row "+r+" key "+t[a])}}}var t,s;before(function(){t=[[1,2,3],[true,false,null,"sheetjs"],["foo","bar",new Date("2014-02-19T14:30Z"),"0.3"],["baz",null,"qux"]];s=sheet_from_array_of_arrays(t)});it("should use first-row headers and full sheet by default",function(){var r=X.utils.sheet_to_json(s);assert.equal(r.length,t.length-1);assert.equal(r[0][1],true);assert.equal(r[1][2],"bar");assert.equal(r[2][3],"qux");assert.doesNotThrow(function(){e(r,[1,2,3],"sheetjs")});assert.throws(function(){e(r,[1,2,3],"baz")})});it("should create array of arrays if header == 1",function(){var r=X.utils.sheet_to_json(s,{header:1});assert.equal(r.length,t.length);assert.equal(r[1][0],true);assert.equal(r[2][1],"bar");assert.equal(r[3][2],"qux");assert.doesNotThrow(function(){e(r,[0,1,2],"sheetjs")});assert.throws(function(){e(r,[0,1,2,3],"sheetjs")});assert.throws(function(){e(r,[0,1,2],"baz")})});it('should use column names if header == "A"',function(){var r=X.utils.sheet_to_json(s,{header:"A"});assert.equal(r.length,t.length);assert.equal(r[1].A,true);assert.equal(r[2].B,"bar");assert.equal(r[3].C,"qux");assert.doesNotThrow(function(){e(r,"ABC","sheetjs")});assert.throws(function(){e(r,"ABCD","sheetjs")});assert.throws(function(){e(r,"ABC","baz")})});it("should use column labels if specified",function(){var r=X.utils.sheet_to_json(s,{header:["O","D","I","N"]});assert.equal(r.length,t.length);assert.equal(r[1].O,true);assert.equal(r[2].D,"bar");assert.equal(r[3].I,"qux");assert.doesNotThrow(function(){e(r,"ODI","sheetjs")});assert.throws(function(){e(r,"ODIN","sheetjs")});assert.throws(function(){e(r,"ODIN","baz")})});[["string","A2:D4"],["numeric",1],["object",{s:{r:1,c:0},e:{r:3,c:3}}]].forEach(function(t){it("should accept custom "+t[0]+" range",function(){var r=X.utils.sheet_to_json(s,{header:1,range:t[1]});assert.equal(r.length,3);assert.equal(r[0][0],true);assert.equal(r[1][1],"bar");assert.equal(r[2][2],"qux");assert.doesNotThrow(function(){e(r,[0,1,2],"sheetjs")});assert.throws(function(){e(r,[0,1,2,3],"sheetjs")});assert.throws(function(){e(r,[0,1,2],"baz")})})})});describe("corner cases",function(){it("output functions",function(){var e=[[1,2,3],[true,false,null,"sheetjs"],["foo","bar",new Date("2014-02-19T14:30Z"),"0.3"],["baz",null,'q"ux']];ws=sheet_from_array_of_arrays(e);ws.A1.f="";ws.A1.w="";delete ws.C3.w;delete ws.C3.z;ws.C3.XF={ifmt:14};ws.A4.t="e";X.utils.get_formulae(ws);X.utils.make_csv(ws);X.utils.make_json(ws);ws["!cols"]=[{wch:6},{wch:7},{wch:10},{wch:20}];var t={SheetNames:["sheetjs"],Sheets:{sheetjs:ws}};X.write(t,{type:"binary",bookType:"xlsx"});X.write(t,{type:"buffer",bookType:"xlsm"});X.write(t,{type:"base64",bookType:"xlsb"});ws.A2.t="f";assert.throws(function(){X.utils.make_json(ws)})});it("SSF",function(){X.SSF.format("General","dafuq");assert.throws(function(e){return X.SSF.format("General",{sheet:"js"})});X.SSF.format("b e ddd hh AM/PM",41722.4097222222);X.SSF.format("b ddd hh m",41722.4097222222);["hhh","hhh A/P","hhmmm","sss","[hhh]","G eneral"].forEach(function(e){assert.throws(function(t){return X.SSF.format(e,12345.6789)})});["[m]","[s]"].forEach(function(e){assert.doesNotThrow(function(t){return X.SSF.format(e,12345.6789)})})});it("SSF oddities",function(){var e=require("./misc/ssf.json");e.forEach(function(e){for(var t=1;t<e.length;++t){if(e[t].length==2){var s=e[t][1],r=X.SSF.format(e[0],e[t][0],{});assert.equal(r,s)}else if(e[t][2]!=="#")assert.throws(function(){SSF.format(e[0],e[t][0])})}})});it("CFB",function(){var e=X.CFB.read(paths.swcxls,{type:"file"});var t=X.parse_xlscfb(e)});it("codepage",function(){X.readFile(dir+"biff5/number_format_greek.xls")})});describe("encryption",function(){password_files.forEach(function(e){describe(e,function(){it("should throw with no password",function(){assert.throws(function(){X.readFile(dir+e)})});it("should throw with wrong password",function(){assert.throws(function(){X.readFile(dir+e,{password:"passwor",WTF:opts.WTF})})});it("should recognize correct password",function(){try{X.readFile(dir+e,{password:"password",WTF:opts.WTF})}catch(e){if(e.message=="Password is incorrect")throw e}});it.skip("should decrypt file",function(){var t=X.readFile(dir+e,{password:"password",WTF:opts.WTF})})})})});